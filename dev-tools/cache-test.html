<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bunny Click 快取測試工具</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #f66fb9 0%, #52b7ff 100%);
        min-height: 100vh;
      }

      .container {
        background: white;
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }

      .test-section {
        margin-bottom: 30px;
        padding: 20px;
        border: 2px solid #f0f0f0;
        border-radius: 12px;
      }

      .test-section h3 {
        color: #f66fb9;
        margin-top: 0;
      }

      button {
        background: linear-gradient(135deg, #f66fb9 0%, #52b7ff 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        margin: 5px;
        transition: transform 0.2s;
      }

      button:hover {
        transform: translateY(-2px);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .log {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        max-height: 300px;
        overflow-y: auto;
      }

      .status {
        padding: 10px;
        border-radius: 6px;
        margin: 10px 0;
        font-weight: 600;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🧪 Bunny Click 快取測試工具</h1>

      <div class="test-section">
        <h3>📦 快取管理測試</h3>
        <button onclick="listCaches()">列出所有快取</button>
        <button onclick="createTestCaches()">創建測試快取</button>
        <button onclick="clearOldCaches()">清除舊快取</button>
        <button onclick="clearAllCaches()">清除所有快取</button>
      </div>

      <div class="test-section">
        <h3>🔄 版本更新測試</h3>
        <button onclick="simulateVersionUpdate()">模擬版本更新</button>
        <button onclick="checkVersion()">檢查當前版本</button>
        <button onclick="resetVersion()">重置版本</button>
      </div>

      <div class="test-section">
        <h3>🧪 自動化測試</h3>
        <button onclick="runFullTest()">執行完整測試</button>
        <button onclick="clearLog()">清除日誌</button>
      </div>

      <div id="status"></div>
      <div id="log" class="log"></div>
    </div>

    <script src="test-cache-clear.js"></script>
    <script>
      const APP_VERSION = '7.2.3';

      function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logElement = document.getElementById('log');
        const statusElement = document.getElementById('status');

        const logMessage = `[${timestamp}] ${message}`;
        logElement.innerHTML += logMessage + '\n';
        logElement.scrollTop = logElement.scrollHeight;

        // 更新狀態
        statusElement.innerHTML = `<div class="status ${type}">${message}</div>`;

        console.log(logMessage);
      }

      async function listCaches() {
        try {
          const cacheNames = await caches.keys();
          log(`📋 找到 ${cacheNames.length} 個快取:`);
          cacheNames.forEach(name => log(`  - ${name}`));

          if (cacheNames.length === 0) {
            log('沒有找到任何快取', 'info');
          }
        } catch (error) {
          log(`❌ 列出快取失敗: ${error.message}`, 'error');
        }
      }

      async function createTestCaches() {
        try {
          const testCaches = [
            'bunny-click-v7.2.3',
            'bunny-click-v7.2.3',
            'bunny-click-v7.2.3',
            'old-test-cache',
          ];

          log('📦 創建測試快取...');

          for (const cacheName of testCaches) {
            const cache = await caches.open(cacheName);
            await cache.put('/test', new Response(`Test data for ${cacheName}`));
            log(`  ✅ 創建快取: ${cacheName}`);
          }

          log('✅ 所有測試快取創建完成', 'success');
        } catch (error) {
          log(`❌ 創建測試快取失敗: ${error.message}`, 'error');
        }
      }

      async function clearOldCaches() {
        try {
          const cacheNames = await caches.keys();
          const currentCachePatterns = [
            `bunny-click-v${APP_VERSION}`,
            'bunny-click-enhanced-v1.1.0-app-shell',
            'bunny-click-enhanced-v1.1.0-static',
            'bunny-click-enhanced-v1.1.0-dynamic',
            'bunny-click-enhanced-v1.1.0-images',
          ];

          log(`🗑️ 清除舊快取 (保留當前版本快取)...`);

          let clearedCount = 0;
          for (const cacheName of cacheNames) {
            if (!currentCachePatterns.includes(cacheName)) {
              await caches.delete(cacheName);
              log(`  🗑️ 已清除: ${cacheName}`);
              clearedCount++;
            } else {
              log(`  ✅ 保留: ${cacheName}`);
            }
          }

          if (clearedCount > 0) {
            log(`✅ 清除了 ${clearedCount} 個舊快取`, 'success');
          } else {
            log('ℹ️ 沒有需要清除的舊快取', 'info');
          }
        } catch (error) {
          log(`❌ 清除舊快取失敗: ${error.message}`, 'error');
        }
      }

      async function clearAllCaches() {
        try {
          const cacheNames = await caches.keys();
          log(`🗑️ 清除所有快取 (${cacheNames.length} 個)...`);

          for (const cacheName of cacheNames) {
            await caches.delete(cacheName);
            log(`  🗑️ 已清除: ${cacheName}`);
          }

          log('✅ 所有快取已清除', 'success');
        } catch (error) {
          log(`❌ 清除所有快取失敗: ${error.message}`, 'error');
        }
      }

      function simulateVersionUpdate() {
        const oldVersion = '7.0.0';
        localStorage.setItem('app_version', oldVersion);
        log(`🔄 模擬版本更新: ${oldVersion} → ${APP_VERSION}`);
        log('💡 重新載入頁面以觸發版本檢測', 'info');
      }

      function checkVersion() {
        const storedVersion = localStorage.getItem('app_version');
        log(`📋 當前版本資訊:`);
        log(`  - 應用版本: ${APP_VERSION}`);
        log(`  - 儲存版本: ${storedVersion || '未設定'}`);

        if (storedVersion !== APP_VERSION) {
          log('⚠️ 版本不一致，需要更新', 'info');
        } else {
          log('✅ 版本一致', 'success');
        }
      }

      function resetVersion() {
        localStorage.removeItem('app_version');
        log('🔄 版本資訊已重置');
      }

      async function runFullTest() {
        log('🧪 開始執行完整測試...');

        try {
          // 1. 創建測試快取
          await createTestCaches();
          await new Promise(resolve => setTimeout(resolve, 1000));

          // 2. 列出快取
          await listCaches();
          await new Promise(resolve => setTimeout(resolve, 1000));

          // 3. 模擬版本更新
          simulateVersionUpdate();
          await new Promise(resolve => setTimeout(resolve, 1000));

          // 4. 清除舊快取
          await clearOldCaches();
          await new Promise(resolve => setTimeout(resolve, 1000));

          // 5. 最終檢查
          await listCaches();

          log('🎉 完整測試執行完成！', 'success');
        } catch (error) {
          log(`❌ 完整測試失敗: ${error.message}`, 'error');
        }
      }

      function clearLog() {
        document.getElementById('log').innerHTML = '';
        document.getElementById('status').innerHTML = '';
      }

      // 頁面載入時的初始化
      window.addEventListener('load', () => {
        log('🚀 快取測試工具已載入');
        checkVersion();
      });
    </script>
  </body>
</html>

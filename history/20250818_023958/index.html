<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover"
    />
    <meta name="theme-color" content="#f6a8d8" />
    <meta name="referrer" content="no-referrer" />
    <meta http-equiv="x-dns-prefetch-control" content="off" />
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin" />

    <!-- Material Symbols from Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0"
      rel="stylesheet"
    />

    <!-- 資源預載入優化 -->
    <link
      rel="preload"
      href="./fonts/FredokaOne-400.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />

    <!-- iOS 仍需要下面這個，Chrome 可能會提示 deprecated，但不影響功能 -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <!-- Chrome/Android 建議加上 -->
    <meta name="mobile-web-app-capable" content="yes" />

    <!-- SEO Meta Tags -->
    <title>Bunny Click - 點擊樂趣遊戲 | 免費線上PWA遊戲</title>
    <meta
      name="description"
      content="Bunny Click 是一款創新的免費線上點擊遊戲，採用先進 PWA 技術支援離線遊戲體驗。精確 TPS (每秒點擊次數) 計算系統，測試提升您的點擊速度極限。獨特粉色×天藍漸層配色設計，支援手機、平板、電腦跨平台使用，無需下載安裝即可開始遊戲。"
    />
    <meta
      name="keywords"
      content="點擊遊戲,Bunny Click,Bunny Click,免費遊戲,PWA遊戲,線上遊戲,TPS計算,點擊速度,手機遊戲,離線遊戲"
    />
    <meta name="author" content="s123104" />
    <meta
      name="robots"
      content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"
    />
    <link rel="canonical" href="https://haotool.org/bunny-click/" />

    <!-- Open Graph Meta Tags -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Bunny Click - 點擊樂趣遊戲 | 免費線上PWA遊戲" />
    <meta
      property="og:description"
      content="Bunny Click 是一款創新的免費線上點擊遊戲，採用先進 PWA 技術支援離線遊戲體驗。精確 TPS 計算系統，測試提升您的點擊速度極限。獨特粉色×天藍漸層配色設計，跨平台使用。"
    />
    <meta property="og:url" content="https://haotool.org/bunny-click/" />
    <meta property="og:site_name" content="Bunny Click" />
    <meta property="og:image" content="https://haotool.org/bunny-click/icons/bunny-click.png" />
    <meta property="og:image:width" content="1024" />
    <meta property="og:image:height" content="1024" />
    <meta property="og:image:alt" content="Bunny Click 點擊樂趣遊戲 - 粉色×天藍配色的免費PWA遊戲" />
    <meta property="og:locale" content="zh_TW" />

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Bunny Click - 點擊樂趣遊戲" />
    <meta
      name="twitter:description"
      content="免費線上點擊遊戲，支援PWA離線遊戲、TPS計算。立即開始點擊樂趣！"
    />
    <meta name="twitter:image" content="https://haotool.org/bunny-click/icons/bunny-click.png" />
    <meta name="twitter:image:alt" content="Bunny Click 點擊樂趣遊戲截圖" />

    <!-- Additional Meta Tags for PWA -->
    <meta name="application-name" content="Bunny Click" />
    <meta name="apple-mobile-web-app-title" content="Bunny Click" />
    <meta name="msapplication-TileColor" content="#f6a8d8" />
    <meta name="format-detection" content="telephone=no" />

    <!-- Manifest（相對路徑，便於子資料夾部署） -->
    <link rel="manifest" href="./app.webmanifest" />

    <!-- AI 搜尋引擎資源檔案 -->
    <link rel="alternate" type="text/plain" href="./llms.txt" title="LLMS Resource File" />
    <meta name="llms-resource" content="./llms.txt" />
    <meta name="ai-answers-api" content="./api/answers.json" />

    <!-- 多語言支援 [context7:/amannn/next-intl:2025-08-17] -->
    <link rel="alternate" hreflang="zh-TW" href="https://haotool.org/bunny-click/" />
    <link rel="alternate" hreflang="zh-CN" href="https://haotool.org/bunny-click/zh-cn/" />
    <link rel="alternate" hreflang="en" href="https://haotool.org/bunny-click/en/" />
    <link rel="alternate" hreflang="x-default" href="https://haotool.org/bunny-click/" />

    <!-- Favicon：用內嵌 SVG，避免 favicon.ico 404 -->
    <link
      rel="icon"
      type="image/svg+xml"
      href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop stop-color="%23f66fb9"/><stop offset="1" stop-color="%2352b7ff"/></linearGradient></defs><rect width="64" height="64" rx="14" fill="url(%23g)"/><path d="M32 6l6 16 17 2-13 10 4 16-14-8-14 8 4-16L9 24l17-2z" fill="white"/></svg>'
    />

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Bunny Click",
        "alternateName": "Bunny Click",
        "description": "Bunny Click 是一款免費的線上點擊遊戲，支援 PWA 離線遊戲、TPS 計算功能。粉色×天藍配色主題，支援手機、平板、電腦多平台使用。",
        "url": "https://haotool.org/bunny-click/",
        "applicationCategory": "Game",
        "applicationSubCategory": "CasualGame",
        "operatingSystem": "Any",
        "browserRequirements": "Requires JavaScript. HTML5 compatible browser.",
        "softwareVersion": "7.2.3",
        "dateCreated": "2024-01-01",
        "dateModified": "2025-08-16",
        "datePublished": "2024-01-01",
        "inLanguage": "zh-TW",
        "isAccessibleForFree": true,
        "author": {
          "@type": "Person",
          "name": "s123104",
          "identifier": "s123104"
        },
        "publisher": {
          "@type": "Person",
          "name": "s123104"
        },
        "offers": {
          "@type": "Offer",
          "price": "0",
          "priceCurrency": "TWD",
          "availability": "https://schema.org/InStock",
          "category": "Free"
        },
        "screenshot": "https://haotool.org/bunny-click/icons/bunny-click.png",
        "image": "https://haotool.org/bunny-click/icons/bunny-click.png",
        "thumbnailUrl": "https://haotool.org/bunny-click/icons/icon-192x192.png",
        "featureList": [
          "TPS (每秒點擊次數) 計算",
          "PWA 離線遊戲支援",
          "多平台相容 (手機、平板、電腦)",
          "粉色×天藍漸層配色主題",
          "即時統計與記錄",
          "無需註冊或登入",
          "支援觸控和滑鼠操作",
          "Service Worker 快取機制"
        ],
        "requirements": "JavaScript enabled browser, HTML5 support",
        "gamePlatform": ["Web Browser", "Mobile", "Desktop", "Progressive Web App"],
        "genre": ["Casual", "Arcade", "Clicker"],
        "playMode": "SinglePlayer",
        "accessibilityFeature": [
          "keyboard navigation",
          "touch support",
          "screen reader compatible"
        ],
        "keywords": "點擊遊戲, Bunny Click, Bunny Click, 免費遊戲, PWA遊戲, 線上遊戲, TPS計算, 點擊速度, 手機遊戲, 離線遊戲",
        "mainEntity": {
          "@type": "Game",
          "name": "Bunny Click",
          "description": "測試你的點擊速度！計算每秒點擊次數 (TPS)，挑戰你的極限。",
          "genre": "Casual Gaming",
          "playMode": "SinglePlayer",
          "gameItem": {
            "@type": "Thing",
            "name": "點擊按鈕",
            "description": "主要遊戲互動元素"
          }
        },
        "potentialAction": {
          "@type": "PlayAction",
          "target": "https://haotool.org/bunny-click/",
          "name": "開始遊戲"
        }
      }
    </script>

    <!-- FAQ Structured Data for Answer Engine Optimization -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [
          {
            "@type": "Question",
            "name": "Bunny Click 是什麼？",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "Bunny Click 是一款免費的線上點擊遊戲，採用 PWA 技術支援離線遊戲體驗。提供精確的 TPS (每秒點擊次數) 計算系統，讓您測試和提升點擊速度。"
            }
          },
          {
            "@type": "Question",
            "name": "如何開始遊戲？",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "開啟瀏覽器訪問 Bunny Click 網站，點擊「單人挑戰模式」或「雙人對戰模式」即可立即開始遊戲，無需下載安裝任何軟體。"
            }
          },
          {
            "@type": "Question",
            "name": "什麼是 TPS 計算？",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "TPS 是 Taps Per Second (每秒點擊次數) 的縮寫，Bunny Click 提供精確的 TPS 計算系統，即時顯示您的點擊速度表現，幫助您挑戰極限。"
            }
          },
          {
            "@type": "Question",
            "name": "支援哪些裝置？",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "Bunny Click 完美支援手機、平板、電腦等多種裝置，採用響應式設計確保在任何螢幕尺寸下都能提供最佳遊戲體驗。"
            }
          },
          {
            "@type": "Question",
            "name": "什麼是 PWA 離線功能？",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "PWA (Progressive Web App) 技術讓 Bunny Click 支援離線遊戲，即使沒有網路連線也能繼續遊戲，並可安裝到裝置主畫面像原生 App 一樣使用。"
            }
          },
          {
            "@type": "Question",
            "name": "遊戲完全免費嗎？",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "是的，Bunny Click 完全免費，無需註冊或登入，無隱藏費用，也沒有廣告干擾，讓您專注享受純粹的點擊樂趣。"
            }
          },
          {
            "@type": "Question",
            "name": "如何提升點擊速度？",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "建議使用食指快速點擊，保持手部放鬆，找到節奏感。練習時可從短時間開始，逐漸增加持續時間，定期查看 TPS 統計來追蹤進步。"
            }
          },
          {
            "@type": "Question",
            "name": "雙人對戰如何進行？",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "選擇雙人對戰模式，兩位玩家可在同一螢幕上競賽，左右分屏設計，即時顯示雙方點擊數和 TPS，增加競爭樂趣和互動性。"
            }
          },
          {
            "@type": "Question",
            "name": "有排行榜功能嗎？",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "有的，Bunny Click 提供本地排行榜功能，記錄您的最佳成績，支援單人模式和雙人對戰模式的分別排名，激勵您不斷挑戰更高分數。"
            }
          },
          {
            "@type": "Question",
            "name": "資料會被保存嗎？",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "所有遊戲記錄和設定都保存在您的裝置本地，確保隱私安全。即使離線也能查看歷史成績，PWA 技術確保資料不會遺失。"
            }
          }
        ]
      }
    </script>

    <!-- VideoGame Schema (Extended) -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "VideoGame",
        "name": "Bunny Click - 點擊樂趣遊戲",
        "alternateName": ["Bunny Click", "Bunny Click", "點擊遊戲"],
        "description": "免費的線上點擊速度測試遊戲，支援 PWA 技術可離線遊戲。測試您的點擊速度，計算 TPS (每秒點擊次數)，享受粉色×天藍的美麗配色。",
        "url": "https://haotool.org/bunny-click/",
        "image": "https://haotool.org/bunny-click/icons/bunny-click.png",
        "genre": ["Casual", "Arcade", "Clicker Game"],
        "playMode": "SinglePlayer",
        "applicationCategory": "Game",
        "gamePlatform": ["PC", "Mobile", "Web Browser", "PWA"],
        "operatingSystem": "Cross-platform",
        "processorRequirements": "Any modern processor",
        "memoryRequirements": "Minimal RAM required",
        "storageRequirements": "< 1MB (PWA cache)",
        "datePublished": "2024-01-01",
        "dateModified": "2025-08-16",
        "version": "7.2.3",
        "inLanguage": "zh-TW",
        "isAccessibleForFree": true,
        "author": {
          "@type": "Person",
          "name": "s123104"
        },
        "publisher": {
          "@type": "Person",
          "name": "s123104"
        },
        "offers": {
          "@type": "Offer",
          "price": "0",
          "priceCurrency": "TWD",
          "availability": "https://schema.org/InStock"
        },
        "aggregateRating": {
          "@type": "AggregateRating",
          "ratingValue": "4.8",
          "ratingCount": "1",
          "bestRating": "5",
          "worstRating": "1"
        },
        "contentRating": "Everyone",
        "keywords": "點擊遊戲, 速度測試, TPS計算, PWA遊戲, 免費遊戲",
        "mainEntityOfPage": "https://haotool.org/bunny-click/"
      }
    </script>

    <!-- HowTo Schema for Voice Search Optimization -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "HowTo",
        "name": "如何玩 Bunny Click 點擊遊戲",
        "description": "學習如何使用 Bunny Click 進行點擊速度測試和提升 TPS 表現的完整指南",
        "totalTime": "PT2M",
        "estimatedCost": {
          "@type": "MonetaryAmount",
          "currency": "TWD",
          "value": "0"
        },
        "supply": [
          {
            "@type": "HowToSupply",
            "name": "任何支援瀏覽器的裝置"
          }
        ],
        "tool": [
          {
            "@type": "HowToTool",
            "name": "滑鼠、觸控螢幕或鍵盤"
          }
        ],
        "step": [
          {
            "@type": "HowToStep",
            "name": "開始遊戲",
            "text": "開啟瀏覽器訪問 Bunny Click 網站，選擇單人挑戰模式或雙人對戰模式開始遊戲",
            "url": "https://haotool.org/bunny-click/#start",
            "image": "https://haotool.org/bunny-click/icons/bunny-click.png"
          },
          {
            "@type": "HowToStep",
            "name": "進行點擊測試",
            "text": "快速點擊遊戲區域，系統會即時計算並顯示您的 TPS (每秒點擊次數) 表現",
            "url": "https://haotool.org/bunny-click/#gameplay"
          },
          {
            "@type": "HowToStep",
            "name": "查看成績",
            "text": "遊戲結束後查看詳細統計數據，包括總點擊數、平均 TPS 和最高 TPS 記錄",
            "url": "https://haotool.org/bunny-click/#results"
          },
          {
            "@type": "HowToStep",
            "name": "提升技巧",
            "text": "使用食指快速點擊，保持手部放鬆，找到節奏感。定期練習以提升點擊速度",
            "url": "https://haotool.org/bunny-click/#tips"
          }
        ]
      }
    </script>

    <style>
      /* 字體定義 - 使用 Google Fonts CDN */

      @font-face {
        font-family: 'Fredoka One';
        src: url('./fonts/FredokaOne-400.woff2') format('woff2');
        font-weight: 400;
        font-style: normal;
        font-display: swap;
        /* 字型度量覆蓋以減少CLS */
        size-adjust: 108%;
        ascent-override: 92%;
        descent-override: 22%;
        line-gap-override: 0%;
      }

      /* 關鍵CSS優化 - 首屏內容優先 */

      :root {
        --pink-50: #fff1f8;
        --pink-100: #ffe6f3;
        --pink-200: #ffcfe9;
        --pink-300: #ffb2dc;
        --pink-400: #ff94d0;
        --pink-500: #f66fb9;
        --pink-600: #e054a3;
        --pink-700: #c24389;
        --sky-50: #ecf6ff;
        --sky-100: #d9efff;
        --sky-200: #bfe6ff;
        --sky-300: #9ed9ff;
        --sky-400: #7ccaff;
        --sky-500: #52b7ff;
        --sky-600: #349ff0;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-900: #111827;

        --primary: var(--pink-500);
        --primary-dark: var(--pink-600);
        --accent: var(--sky-500);
        --bg-primary: #ffffff;
        --bg-secondary: var(--gray-50);
        --bg-tertiary: var(--gray-100);
        --text-primary: var(--gray-900);
        --text-secondary: var(--gray-600);

        --shadow-md: 0 6px 18px rgba(0, 0, 0, 0.08);
        --shadow-xl: 0 20px 45px rgba(246, 111, 185, 0.28);
        --space-2: 0.5rem;
        --space-3: 0.75rem;
        --space-4: 1rem;
        --space-5: 1.25rem;
        --space-6: 1.5rem;
        --space-8: 2rem;
        --space-10: 2.5rem;
        --space-16: 4rem;
        --radius-xl: 1rem;
        --radius-2xl: 1.5rem;
        --duration-fast: 150ms;
        --duration-normal: 300ms;

        --font-size-xs: 0.78rem;
        --font-size-sm: 0.875rem;
        --font-size-2xl: 1.5rem;
        --font-size-4xl: 2.25rem;
        --font-size-6xl: 3.6rem;
      }

      /* 版本更新提示樣式 */
      .version-update-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        background: linear-gradient(135deg, #f66fb9, #52b7ff);
        color: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        animation: slideInRight 0.5s ease-out;
        max-width: 350px;
      }

      .toast-content {
        display: flex;
        align-items: center;
        padding: 16px;
        gap: 12px;
      }

      .toast-icon {
        font-size: 24px;
        animation: bounce 2s infinite;
      }

      .toast-text {
        flex: 1;
      }

      .toast-title {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 4px;
      }

      .toast-subtitle {
        font-size: 12px;
        opacity: 0.9;
      }

      .toast-close {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 4px;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
      }

      .toast-close:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes bounce {
        0%,
        20%,
        50%,
        80%,
        100% {
          transform: translateY(0);
        }
        40% {
          transform: translateY(-10px);
        }
        60% {
          transform: translateY(-5px);
        }
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        touch-action: manipulation;
      }
      html,
      body {
        height: 100svh;
        width: 100vw;
        overflow: hidden;
        background: #fff;
        color: var(--text-primary);
        -webkit-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
        -webkit-tap-highlight-color: transparent;
        overscroll-behavior: none;
        -webkit-text-size-adjust: 100%;
      }
      .material-symbols-rounded {
        font-family: 'Material Symbols Rounded';
        font-weight: 600;
        font-style: normal;
        font-size: 22px;
        line-height: 1;
        display: inline-block;
        vertical-align: middle;
        text-align: center;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
        -webkit-font-smoothing: antialiased;
        text-rendering: optimizeLegibility;
        -moz-osx-font-smoothing: grayscale;
        font-feature-settings: 'liga';
        font-variant-ligatures: normal;
        font-variation-settings:
          'FILL' 0,
          'wght' 600,
          'GRAD' 0,
          'opsz' 24;
        visibility: hidden;
      }

      .fonts-ready .material-symbols-rounded {
        visibility: visible;
      }

      /* Material Symbols 實心樣式控制 */
      .material-symbols-rounded.fill {
        font-variation-settings:
          'FILL' 1,
          'wght' 600,
          'GRAD' 0,
          'opsz' 24;
      }

      /* Material Symbols 不同粗細控制 */
      .material-symbols-rounded.light {
        font-variation-settings:
          'FILL' 0,
          'wght' 300,
          'GRAD' 0,
          'opsz' 24;
      }

      .material-symbols-rounded.bold {
        font-variation-settings:
          'FILL' 0,
          'wght' 700,
          'GRAD' 0,
          'opsz' 24;
      }

      .app {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100svh;
        overflow: hidden;
        background:
          radial-gradient(1100px 800px at 20% 10%, rgba(255, 210, 236, 0.55), transparent 60%),
          radial-gradient(1100px 800px at 85% 85%, rgba(124, 202, 255, 0.45), transparent 60%),
          linear-gradient(135deg, var(--pink-100) 0%, var(--pink-50) 40%, var(--sky-100) 100%);
        contain: paint style layout;
      }
      .app.rgb-burst {
        animation: hueCycle 0.8s linear infinite;
      }
      @keyframes hueCycle {
        from {
          filter: hue-rotate(0);
        }
        to {
          filter: hue-rotate(360deg);
        }
      }

      .menu-screen {
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: var(--space-10);
        padding: var(--space-8);
      }
      .menu-screen.hidden {
        opacity: 0;
        visibility: hidden;
        transition: all var(--duration-normal) ease;
      }
      .brand {
        text-align: center;
      }
      .brand-icon {
        width: 120px;
        height: 120px;
        margin: 0 auto var(--space-6);
        background: conic-gradient(from 0deg, #ffd9ef, #dff2ff, #ffd9ef);
        border-radius: 28px;
        display: grid;
        place-items: center;
        box-shadow: var(--shadow-xl);
        animation: float 3s ease-in-out infinite;
      }
      @keyframes float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }
      .brand-title {
        font-family:
          'Fredoka One',
          system-ui,
          -apple-system,
          sans-serif;
        font-size: 2.2rem;
        font-weight: 400;
        letter-spacing: 0.02em;
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 60%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 2px 2px 0px rgba(255, 255, 255, 0.3);
      }
      .brand-subtitle {
        color: var(--text-secondary);
        margin-top: 0.4rem;
      }
      .product-description {
        max-width: min(90vw, 480px);
        margin: 1.5rem auto 0;
        padding: 1rem 0;
      }
      .product-description p {
        color: var(--text-secondary);
        font-size: 0.95rem;
        line-height: 1.6;
        text-align: center;
        margin: 0;
        opacity: 0.9;
      }
      .menu-buttons {
        display: grid;
        gap: var(--space-4);
        width: min(90vw, 360px);
      }
      .features-section {
        max-width: min(95vw, 800px);
        margin: 2rem auto 0;
        padding: 2rem 1rem;
        background: rgba(255, 255, 255, 0.02);
        border-radius: var(--radius-2xl);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .features-title,
      .why-title {
        font-size: 1.4rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 1.5rem;
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 60%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .feature-grid {
        display: grid;
        gap: 1.5rem;
        margin-bottom: 2rem;
      }
      @media (min-width: 768px) {
        .feature-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      .feature-item {
        text-align: center;
        padding: 1rem;
      }
      .feature-heading {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.8rem;
        color: var(--text-primary);
      }
      .feature-text {
        font-size: 0.9rem;
        line-height: 1.5;
        color: var(--text-secondary);
        margin: 0;
      }
      .why-choose {
        text-align: center;
        margin-top: 2rem;
      }
      .benefits-list {
        display: grid;
        gap: 0.8rem;
        list-style: none;
        padding: 0;
        margin: 1rem 0 0;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
      }
      @media (min-width: 600px) {
        .benefits-list {
          grid-template-columns: repeat(2, 1fr);
          gap: 1rem;
        }
      }
      .benefits-list li {
        font-size: 0.9rem;
        color: var(--text-secondary);
        text-align: left;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: var(--radius-lg);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }
      .menu-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 16px 20px;
        border: 0;
        border-radius: 16px;
        font-weight: 800;
        cursor: pointer;
        box-shadow: var(--shadow-md);
        transition:
          transform var(--duration-fast) ease,
          box-shadow var(--duration-fast) ease;
        min-height: 64px;
      }
      .menu-btn:active {
        transform: scale(0.98);
      }
      .menu-btn-primary {
        color: #fff;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      }
      .menu-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 36px rgba(246, 111, 185, 0.35);
      }
      .menu-btn-secondary {
        background: var(--bg-primary);
        color: var(--sky-600);
        border: 2px solid var(--sky-200);
      }
      .menu-btn-secondary:hover {
        background: var(--sky-50);
        border-color: var(--sky-300);
        color: var(--sky-600);
        transform: translateY(-1px);
      }

      .game-screen {
        position: absolute;
        inset: 0;
        display: none;
        flex-direction: column;
      }
      .game-screen.active {
        display: flex;
      }
      .game-header {
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        z-index: 100;
        height: 90px;
        padding-top: calc(env(safe-area-inset-top) + 8px);
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.98) 0%,
          rgba(249, 250, 251, 0.95) 50%,
          rgba(255, 255, 255, 0.98) 100%
        );
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(246, 111, 185, 0.15);
        box-shadow:
          0 4px 25px rgba(246, 111, 185, 0.08),
          0 1px 0 rgba(255, 255, 255, 0.8) inset;
        display: grid;
        grid-template-columns: auto 1fr auto auto;
        align-items: center;
        gap: 20px;
        padding-left: var(--space-6);
        padding-right: var(--space-6);
      }
      .game-header.hidden {
        display: none;
      }
      .game-timer {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 900;
        color: var(--primary);
        font-size: var(--font-size-2xl);
        padding: 10px 16px;
        background: linear-gradient(
          135deg,
          rgba(246, 111, 185, 0.12) 0%,
          rgba(246, 111, 185, 0.08) 100%
        );
        border-radius: 16px;
        border: 1px solid rgba(246, 111, 185, 0.25);
        box-shadow:
          0 2px 8px rgba(246, 111, 185, 0.1),
          0 1px 0 rgba(255, 255, 255, 0.8) inset;
        min-width: 90px;
        justify-content: center;
        transition: all 0.2s ease;
      }
      .game-timer:hover {
        transform: translateY(-1px);
        box-shadow:
          0 4px 15px rgba(246, 111, 185, 0.15),
          0 1px 0 rgba(255, 255, 255, 0.9) inset;
      }
      .game-mode {
        font-size: var(--font-size-sm);
        color: var(--sky-600);
        background: linear-gradient(
          135deg,
          rgba(82, 183, 255, 0.12) 0%,
          rgba(82, 183, 255, 0.06) 50%,
          rgba(255, 255, 255, 0.8) 100%
        );
        padding: 10px 20px;
        border-radius: 25px;
        border: 1px solid rgba(82, 183, 255, 0.25);
        box-shadow:
          0 2px 8px rgba(82, 183, 255, 0.08),
          0 1px 0 rgba(255, 255, 255, 0.8) inset;
        font-weight: 700;
        text-align: center;
        white-space: nowrap;
        transition: all 0.2s ease;
        letter-spacing: 0.3px;
      }
      .game-mode:hover {
        transform: translateY(-1px);
        box-shadow:
          0 4px 15px rgba(82, 183, 255, 0.12),
          0 1px 0 rgba(255, 255, 255, 0.9) inset;
      }
      .game-exit {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.2);
        color: #ef4444;
        padding: 8px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
      }
      .game-exit:hover {
        background: rgba(239, 68, 68, 0.15);
        border-color: rgba(239, 68, 68, 0.3);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
      }
      .game-exit:active {
        transform: translateY(0);
      }
      .header-tps {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1px;
        padding: 10px 20px;
        font-size: var(--font-size-sm);
        color: var(--sky-600);
        background: linear-gradient(
          135deg,
          rgba(82, 183, 255, 0.12) 0%,
          rgba(82, 183, 255, 0.06) 50%,
          rgba(255, 255, 255, 0.8) 100%
        );
        border-radius: 25px;
        border: 1px solid rgba(82, 183, 255, 0.25);
        box-shadow:
          0 2px 8px rgba(82, 183, 255, 0.08),
          0 1px 0 rgba(255, 255, 255, 0.8) inset;
        font-weight: 700;
        text-align: center;
        white-space: nowrap;
        transition: all 0.2s ease;
        letter-spacing: 0.3px;
        min-width: 70px;
        position: relative;
        overflow: hidden;
      }
      .header-tps:hover {
        transform: translateY(-1px);
        box-shadow:
          0 6px 20px rgba(82, 183, 255, 0.15),
          0 1px 0 rgba(255, 255, 255, 0.95) inset;
      }
      .header-tps::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        transition: left 0.5s ease;
      }
      .header-tps:hover::before {
        left: 100%;
      }
      .header-tps .hud-tps-label {
        font-size: 0.6rem;
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .header-tps .hud-tps-value {
        font-size: 0.85rem;
        color: var(--sky-600);
        font-weight: 900;
        font-family: 'Courier New', monospace;
        line-height: 1;
      }
      .header-tps.ultra-speed {
        background: linear-gradient(
          135deg,
          rgba(246, 111, 185, 0.95) 0%,
          rgba(82, 183, 255, 0.95) 25%,
          rgba(255, 182, 193, 0.95) 50%,
          rgba(173, 216, 230, 0.95) 75%,
          rgba(246, 111, 185, 0.95) 100%
        );
        background-size: 300% 300%;
        animation: pinkBlueRGB 1.2s linear infinite;
        border-color: rgba(255, 255, 255, 0.9);
        box-shadow:
          0 0 25px rgba(246, 111, 185, 0.6),
          0 0 35px rgba(82, 183, 255, 0.4),
          0 1px 0 rgba(255, 255, 255, 0.95) inset;
        color: white;
        font-weight: 900;
        transform: translateY(-1px) scale(1.02);
      }
      .header-tps.ultra-speed .hud-tps-value {
        color: white;
        font-weight: 900;
        text-shadow:
          0 0 12px rgba(255, 255, 255, 0.9),
          0 0 20px rgba(246, 111, 185, 0.7),
          0 0 30px rgba(82, 183, 255, 0.5);
        transform: scale(1.05);
      }
      .header-tps.ultra-speed .hud-tps-label {
        color: white;
        font-weight: 800;
        text-shadow:
          0 0 8px rgba(255, 255, 255, 0.8),
          0 0 15px rgba(246, 111, 185, 0.6);
      }

      .game-area {
        position: relative;
        flex: 1;
        touch-action: none;
        overflow: hidden;
        margin-top: 0;
      }
      .app.single .game-area {
        margin-top: calc(80px + env(safe-area-inset-top));
      }
      canvas.fx {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 5;
        pointer-events: none;
      }

      .single-player-area {
        position: absolute;
        inset: 0;
        z-index: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: linear-gradient(
          135deg,
          var(--pink-100) 0%,
          var(--pink-200) 56%,
          var(--sky-100) 100%
        );
      }

      .dual-player-area {
        position: absolute;
        inset: 0;
        z-index: 1;
        display: grid;
        grid-template-rows: 1fr 1fr;
        height: 100%;
        /* 性能優化 - 避免首屏渲染 */
        content-visibility: auto;
        contain-intrinsic-size: 1px 600px;
      }
      .player-zone {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        transition: transform var(--duration-fast) ease;
        background: linear-gradient(135deg, var(--pink-100) 0%, var(--pink-200) 100%);
      }
      .player-zone.player2 {
        background: linear-gradient(135deg, var(--sky-100) 0%, var(--sky-200) 100%);
      }
      .dual-player-area .player-zone.player1 {
        transform: rotate(180deg);
      }
      .dual-player-area .player-zone.player1.active {
        transform: rotate(180deg) scale(1.02);
      }
      .dual-player-area .player-zone.player2.active {
        transform: scale(1.02);
      }

      .divider {
        position: absolute;
        left: 0;
        right: 0;
        top: 50%;
        height: 4px;
        transform: translateY(-50%);
        background: linear-gradient(90deg, var(--primary), var(--accent));
        z-index: 2;
      }

      .player-hud {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 10;
        padding: 8px 16px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.86);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(246, 111, 185, 0.25);
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.06);
        font-weight: 800;
        min-width: 200px;
        justify-content: center;
      }
      .hud-timer {
        color: var(--primary);
        font-size: var(--font-size-2xl);
        font-weight: 900;
        white-space: nowrap;
      }
      .hud-mode {
        color: var(--text-secondary);
        font-size: var(--font-size-sm);
        padding: 2px 8px;
        background: var(--bg-tertiary);
        border-radius: 999px;
        white-space: nowrap;
      }
      .hud-tps-wrapper {
        display: none;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
      }
      .hud-tps-wrapper.show {
        display: flex;
      }
      .hud-tps-wrapper.ultra-speed {
        background: linear-gradient(
          45deg,
          rgba(246, 111, 185, 0.95) 0%,
          rgba(82, 183, 255, 0.95) 25%,
          rgba(255, 182, 193, 0.95) 50%,
          rgba(173, 216, 230, 0.95) 75%,
          rgba(246, 111, 185, 0.95) 100%
        );
        background-size: 300% 300%;
        animation: pinkBlueRGB 1.2s linear infinite;
        box-shadow:
          0 0 25px rgba(246, 111, 185, 0.6),
          0 0 35px rgba(82, 183, 255, 0.4);
        border-radius: 10px;
      }
      .hud-tps-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
        min-width: 50px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 6px;
        padding: 4px 8px;
      }
      .single-hud {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        flex-direction: column;
        align-items: center;
        border-radius: 16px;
        gap: 4px;
      }
      .single-hud .hud-tps-container {
        margin-top: 4px;
      }
      .player-hud .hud-timer {
        color: var(--primary);
      }
      .player-hud .hud-mode {
        color: var(--text-secondary);
        font-size: var(--font-size-sm);
        padding: 2px 8px;
        background: var(--bg-tertiary);
        border-radius: 999px;
      }
      .hud-tps {
        color: var(--sky-600);
        font-size: var(--font-size-xs);
        font-weight: 900;
        display: none;
        min-width: 50px;
        text-align: center;
        font-family: 'Courier New', monospace;
        letter-spacing: 0.3px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        padding: 2px 4px;
        border: 1px solid rgba(82, 183, 255, 0.3);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        line-height: 1.2;
      }
      .hud-tps-label {
        font-size: 0.65rem;
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .hud-tps-value {
        font-size: var(--font-size-xs);
        color: var(--sky-600);
        font-weight: 900;
        font-family: 'Courier New', monospace;
      }
      .hud-tps.show {
        display: inline-block;
      }
      .hud-tps-value.ultra-speed {
        color: white;
        font-weight: 900;
        text-shadow:
          0 0 12px rgba(255, 255, 255, 0.9),
          0 0 20px rgba(246, 111, 185, 0.7),
          0 0 30px rgba(82, 183, 255, 0.5);
        transform: scale(1.05);
      }
      @keyframes rainbowShift {
        0% {
          background-position: 0% 50%;
        }
        25% {
          background-position: 100% 50%;
        }
        50% {
          background-position: 200% 50%;
        }
        75% {
          background-position: 300% 50%;
        }
        100% {
          background-position: 400% 50%;
        }
      }
      @keyframes pinkBlueRGB {
        0% {
          background-position: 0% 50%;
          filter: hue-rotate(0deg) saturate(1.2);
        }
        25% {
          background-position: 100% 50%;
          filter: hue-rotate(90deg) saturate(1.4);
        }
        50% {
          background-position: 200% 50%;
          filter: hue-rotate(180deg) saturate(1.6);
        }
        75% {
          background-position: 100% 50%;
          filter: hue-rotate(270deg) saturate(1.4);
        }
        100% {
          background-position: 0% 50%;
          filter: hue-rotate(360deg) saturate(1.2);
        }
      }

      @keyframes victoryFlash {
        0% {
          filter: brightness(1) saturate(1);
        }
        15% {
          filter: brightness(1.3) saturate(1.2) hue-rotate(10deg);
        }
        30% {
          filter: brightness(1.6) saturate(1.4) hue-rotate(-10deg);
        }
        50% {
          filter: brightness(1.8) saturate(1.6) hue-rotate(20deg);
        }
        70% {
          filter: brightness(1.4) saturate(1.3) hue-rotate(-5deg);
        }
        85% {
          filter: brightness(1.1) saturate(1.1) hue-rotate(5deg);
        }
        100% {
          filter: brightness(1) saturate(1);
        }
      }

      .player-name {
        color: var(--text-secondary);
        font-weight: 600;
        margin-bottom: var(--space-6);
      }
      .score-display {
        font-size: var(--font-size-6xl);
        font-weight: 900;
        color: var(--primary);
        text-shadow: 0 6px 16px rgba(246, 111, 185, 0.35);
        z-index: 3;
      }

      .firework-container {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 200;
      }
      .firework {
        position: absolute;
        width: 4px;
        height: 4px;
        border-radius: 50%;
      }

      .modal {
        position: fixed;
        inset: 0;
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all var(--duration-normal) ease;
        /* 性能優化 - 避免首屏渲染 */
        content-visibility: auto;
        contain-intrinsic-size: 1px 1000px;
      }
      .modal.show {
        display: flex;
        opacity: 1;
        visibility: visible;
      }
      .modal-card {
        background: var(--bg-primary);
        border-radius: var(--radius-2xl);
        padding: var(--space-8);
        text-align: center;
        box-shadow: var(--shadow-xl);
        transform: scale(0.92);
        transition: transform var(--duration-normal) ease;
        max-width: 90vw;
      }

      .single-result {
        max-width: 450px;
        width: 92vw;
      }
      .modal.show .modal-card {
        transform: scale(1);
      }
      .title-gradient {
        font-size: 1.8rem;
        font-weight: 900;
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 60%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .result-card {
        max-width: 420px;
        padding: 32px 24px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.95) 0%,
          rgba(249, 250, 251, 0.95) 100%
        );
        backdrop-filter: blur(20px);
        border: 1px solid rgba(246, 111, 185, 0.2);
        box-shadow:
          0 25px 50px rgba(0, 0, 0, 0.15),
          0 0 0 1px rgba(255, 255, 255, 0.5);
      }

      /* 雙人模式結果樣式 */
      .dual-result-card {
        max-width: 600px;
        padding: 32px 24px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.95) 0%,
          rgba(249, 250, 251, 0.95) 100%
        );
        backdrop-filter: blur(20px);
        border: 1px solid rgba(246, 111, 185, 0.2);
        box-shadow:
          0 25px 50px rgba(0, 0, 0, 0.15),
          0 0 0 1px rgba(255, 255, 255, 0.5);
        border-radius: var(--radius-2xl);
      }

      .dual-result-header {
        text-align: center;
        margin-bottom: 32px;
        position: relative;
      }

      .winner-crown {
        font-size: 48px;
        margin-bottom: 12px;
        animation: crownFloat 2s ease-in-out infinite;
        filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.6));
      }

      @keyframes crownFloat {
        0%,
        100% {
          transform: translateY(0) rotate(0deg);
        }
        25% {
          transform: translateY(-8px) rotate(2deg);
        }
        50% {
          transform: translateY(-12px) rotate(0deg);
        }
        75% {
          transform: translateY(-8px) rotate(-2deg);
        }
      }

      .dual-result-title {
        font-size: 1.75rem;
        font-weight: 900;
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 60%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 4px;
      }

      .dual-result-subtitle {
        color: var(--text-secondary);
        font-size: 0.9rem;
        font-weight: 500;
      }

      .players-comparison {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 32px;
        gap: 20px;
      }

      .player-result {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 16px 12px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.6);
        border: 2px solid rgba(246, 111, 185, 0.1);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        min-width: 0;
      }

      .player-result.winner {
        background: linear-gradient(
          135deg,
          rgba(255, 215, 0, 0.15) 0%,
          rgba(255, 193, 7, 0.1) 50%,
          rgba(255, 235, 59, 0.15) 100%
        );
        border-color: rgba(255, 215, 0, 0.4);
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        animation: winnerGlow 2s ease-in-out infinite alternate;
      }

      @keyframes winnerGlow {
        from {
          box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }
        to {
          box-shadow:
            0 0 40px rgba(255, 215, 0, 0.5),
            0 0 60px rgba(255, 215, 0, 0.2);
        }
      }

      .player-result.winner::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, #ffd700, #ffed4e, #fff176, #ffd700);
        background-size: 400% 400%;
        animation: goldenBorder 3s linear infinite;
        border-radius: 18px;
        z-index: -1;
      }

      @keyframes goldenBorder {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      .player-medal {
        margin-bottom: 16px;
        position: relative;
      }

      .medal-icon {
        font-size: 48px;
        transition: all 0.3s ease;
      }

      .player-result.winner .medal-icon {
        font-size: 56px;
        animation: medalSpin 2s ease-in-out infinite;
        filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.8));
      }

      @keyframes medalSpin {
        0% {
          transform: rotateY(0deg) scale(1);
        }
        25% {
          transform: rotateY(90deg) scale(1.1);
        }
        50% {
          transform: rotateY(180deg) scale(1.2);
        }
        75% {
          transform: rotateY(270deg) scale(1.1);
        }
        100% {
          transform: rotateY(360deg) scale(1);
        }
      }

      .player-info {
        text-align: center;
        width: 100%;
      }

      .player-name {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 12px;
      }

      .player-result.winner .player-name {
        color: #b8860b;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        animation: nameGlow 2s ease-in-out infinite alternate;
      }

      @keyframes nameGlow {
        from {
          text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        to {
          text-shadow:
            0 0 20px rgba(255, 215, 0, 0.8),
            0 0 30px rgba(255, 215, 0, 0.3);
        }
      }

      .player-stats {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .player-score,
      .player-tps {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 8px;
        border: 1px solid rgba(246, 111, 185, 0.1);
      }

      .score-label,
      .tps-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        font-weight: 600;
      }

      .score-value {
        font-size: 1.4rem;
        font-weight: 900;
        color: var(--primary);
      }

      .tps-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--accent);
        font-family: 'Courier New', monospace;
      }

      .tps-value.high-tps {
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: tpsGlow 1s ease-in-out infinite alternate;
      }

      @keyframes tpsGlow {
        from {
          filter: drop-shadow(0 0 2px rgba(246, 111, 185, 0.5));
        }
        to {
          filter: drop-shadow(0 0 8px rgba(82, 183, 255, 0.5));
        }
      }

      .vs-divider {
        display: flex;
        align-items: center;
        justify-content: center;
        width: auto;
        height: auto;
        font-weight: 900;
        font-size: 0.9rem;
        flex-shrink: 0;
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        color: transparent;
      }

      .dual-achievement-section {
        text-align: center;
        margin-bottom: 24px;
      }

      .dual-achievement-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        color: white;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 700;
        animation: badgePulse 2s ease-in-out infinite alternate;
      }

      @keyframes badgePulse {
        from {
          box-shadow: 0 0 15px rgba(246, 111, 185, 0.4);
        }
        to {
          box-shadow:
            0 0 25px rgba(82, 183, 255, 0.6),
            0 0 35px rgba(246, 111, 185, 0.3);
        }
      }

      /* 響應式設計 */
      @media (max-width: 640px) {
        .dual-result-card {
          max-width: 95vw;
          padding: 24px 16px;
          margin: 10px;
        }

        .dual-result-header {
          margin-bottom: 24px;
        }

        .winner-crown {
          font-size: 40px;
          margin-bottom: 8px;
        }

        .dual-result-title {
          font-size: 1.5rem;
        }

        .players-comparison {
          flex-direction: row;
          gap: 8px;
          margin-bottom: 20px;
          align-items: stretch;
        }

        .vs-divider {
          width: auto;
          height: auto;
          font-size: 0.75rem;
          margin: 0 4px;
          flex-shrink: 0;
          align-self: center;
        }

        .player-result {
          flex: 1;
          min-width: 0;
          padding: 12px 8px;
          margin: 0;
        }

        .medal-icon {
          font-size: 40px;
        }

        .player-result.winner .medal-icon {
          font-size: 48px;
        }

        .player-name {
          font-size: 1rem;
          margin-bottom: 8px;
        }

        .player-score,
        .player-tps {
          padding: 4px 8px;
          font-size: 0.85rem;
        }

        .score-value,
        .tps-value {
          font-size: 1.1rem;
        }

        .dual-result-card .result-actions {
          margin-top: 16px;
        }

        .dual-result-card .result-btn {
          padding: 10px 16px;
          font-size: 0.9rem;
          min-height: 44px;
          touch-action: manipulation;
        }

        .dual-result-card .result-btn.compact {
          font-size: 0.85rem;
        }

        .score-value {
          font-size: 1.2rem;
        }

        .tps-value {
          font-size: 1rem;
        }

        .dual-achievement-section {
          margin-bottom: 20px;
        }

        .dual-achievement-badge {
          padding: 10px 16px;
          font-size: 0.85rem;
        }

        .result-actions {
          flex-direction: row;
          gap: 8px;
          justify-content: space-between;
          align-items: center;
        }

        .result-btn {
          flex: 1;
          max-width: 140px;
          padding: 10px 12px;
          font-size: 0.85rem;
        }
      }

      .result-header {
        text-align: center;
        margin-bottom: 24px;
      }

      .trophy-icon {
        font-size: 48px;
        margin-bottom: 12px;
        animation: bounce 2s ease-in-out infinite;
      }

      .result-title {
        font-size: 1.75rem;
        font-weight: 900;
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 60%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 4px;
      }

      .result-subtitle {
        color: var(--text-secondary);
        font-size: 0.9rem;
        font-weight: 500;
      }

      .result-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 24px;
      }

      .stat-item {
        text-align: center;
        padding: 16px 12px;
        background: rgba(255, 255, 255, 0.6);
        border-radius: 12px;
        border: 1px solid rgba(246, 111, 185, 0.1);
      }

      .stat-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }

      .stat-value {
        font-size: 1.5rem;
        font-weight: 900;
        color: var(--primary);
      }

      .main-score .stat-value {
        font-size: 2rem;
      }

      .tps-value {
        font-family: 'Courier New', monospace;
        color: var(--accent);
      }

      .result-stats .tps-value {
        font-size: 2rem;
      }

      .achievement-section {
        text-align: center;
        margin-bottom: 24px;
      }

      .achievement-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        color: white;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 700;
        animation: glow 2s ease-in-out infinite alternate;
      }

      .badge-icon {
        font-size: 1.1rem;
      }

      .result-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .result-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 12px 20px;
        font-weight: 700;
        border-radius: 12px;
        transition: all 0.2s ease;
        justify-content: center;
        min-width: 140px;
      }

      .result-btn:hover {
        transform: translateY(-1px);
      }

      @keyframes bounce {
        0%,
        20%,
        50%,
        80%,
        100% {
          transform: translateY(0);
        }
        40% {
          transform: translateY(-10px);
        }
        60% {
          transform: translateY(-5px);
        }
      }

      @keyframes glow {
        from {
          box-shadow: 0 0 10px rgba(246, 111, 185, 0.3);
        }
        to {
          box-shadow:
            0 0 20px rgba(82, 183, 255, 0.4),
            0 0 30px rgba(246, 111, 185, 0.2);
        }
      }
      .btn {
        border: 0;
        border-radius: 14px;
        padding: 12px 18px;
        font-weight: 800;
        cursor: pointer;
      }
      .btn-primary {
        color: #fff;
        background: linear-gradient(135deg, var(--primary) 0%, var(--pink-700) 100%);
        box-shadow: 0 10px 24px rgba(246, 111, 185, 0.35);
      }
      .btn-secondary {
        background: var(--bg-secondary);
        border: 1px solid var(--gray-300);
      }
      .btn-powder-blue {
        background: var(--sky-500);
        color: white;
        border: none;
        box-shadow: 0 6px 18px rgba(82, 183, 255, 0.28);
      }
      .btn-powder-blue:hover {
        background: var(--sky-600);
        transform: translateY(-1px);
      }
      .btn-white-powder-text {
        background: white;
        color: var(--sky-500);
        border: 2px solid var(--sky-300);
        font-weight: 700;
      }
      .btn-white-powder-text:hover {
        background: var(--sky-50);
        border-color: var(--sky-400);
      }

      .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border: none;
        box-shadow: 0 6px 18px rgba(239, 68, 68, 0.28);
      }

      .btn-danger:hover {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        transform: translateY(-1px);
      }

      .leaderboard-card {
        max-width: 90vw;
        width: 600px;
        max-height: 80vh;
        padding: 20px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.95) 0%,
          rgba(249, 250, 251, 0.95) 100%
        );
        backdrop-filter: blur(20px);
        border: 1px solid rgba(246, 111, 185, 0.2);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .leaderboard-header {
        margin-bottom: 20px;
      }

      .leaderboard-title {
        font-size: 1.5rem;
        font-weight: 900;
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 60%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        text-align: center;
        margin-bottom: 16px;
      }

      .leaderboard-tabs {
        display: flex;
        background: rgba(255, 255, 255, 0.6);
        border-radius: 12px;
        padding: 4px;
        border: 1px solid rgba(246, 111, 185, 0.1);
      }

      .tab-btn {
        flex: 1;
        padding: 8px 16px;
        border: none;
        background: transparent;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.85rem;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .tab-btn.active {
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(246, 111, 185, 0.3);
      }

      .tab-btn:hover:not(.active) {
        background: rgba(246, 111, 185, 0.1);
        color: var(--primary);
      }

      .leaderboard-time-tabs {
        display: flex;
        background: rgba(82, 183, 255, 0.1);
        border-radius: 10px;
        padding: 3px;
        margin-bottom: 16px;
        gap: 2px;
      }

      .time-tab-btn {
        flex: 1;
        padding: 6px 12px;
        border: none;
        background: transparent;
        border-radius: 7px;
        font-weight: 500;
        font-size: 0.8rem;
        color: var(--sky-600);
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .time-tab-btn.active {
        background: var(--sky-500);
        color: white;
        box-shadow: 0 2px 6px rgba(82, 183, 255, 0.3);
      }

      .time-tab-btn:hover:not(.active) {
        background: rgba(82, 183, 255, 0.15);
        color: var(--sky-700);
      }

      .leaderboard-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        margin-bottom: 16px;
      }

      .leaderboard-list {
        flex: 1;
        overflow-y: auto;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.4);
        border: 1px solid rgba(246, 111, 185, 0.1);
        min-height: 200px;
        -webkit-overflow-scrolling: touch;
      }

      .leaderboard-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid rgba(246, 111, 185, 0.1);
        transition: background 0.2s ease;
      }

      .leaderboard-item:hover {
        background: rgba(246, 111, 185, 0.05);
      }

      .leaderboard-item:last-child {
        border-bottom: none;
      }

      .rank-badge {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 900;
        font-size: 0.85rem;
        margin-right: 12px;
      }

      .rank-1 {
        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        color: #92400e;
      }
      .rank-2 {
        background: linear-gradient(135deg, #c0c0c0 0%, #e5e7eb 100%);
        color: #374151;
      }
      .rank-3 {
        background: linear-gradient(135deg, #cd7f32 0%, #f59e0b 100%);
        color: #92400e;
      }
      .rank-other {
        background: rgba(246, 111, 185, 0.1);
        color: var(--primary);
      }

      .player-info {
        flex: 1;
      }

      .player-name {
        font-weight: 700;
        color: var(--text-primary);
        font-size: 0.9rem;
      }

      .player-date {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 2px;
      }

      .score-info {
        text-align: right;
      }

      .score-value {
        font-weight: 900;
        font-size: 1.1rem;
        color: var(--primary);
      }

      .tps-info {
        font-size: 0.75rem;
        color: var(--accent);
        font-family: 'Courier New', monospace;
        margin-top: 2px;
      }

      .pagination {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
        margin-top: 16px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.4);
        border-radius: 12px;
        border: 1px solid rgba(246, 111, 185, 0.1);
      }

      .page-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 1px solid rgba(246, 111, 185, 0.2);
        background: rgba(255, 255, 255, 0.8);
        color: var(--primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .page-btn:hover:not(:disabled) {
        background: var(--primary);
        color: white;
        transform: scale(1.05);
      }

      .page-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .page-info {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.9rem;
      }

      .leaderboard-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
        flex-shrink: 0;
        padding-top: 8px;
      }
      .leaderboard-actions .btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 10px 16px;
        font-weight: 600;
        border-radius: 10px;
        transition: all 0.2s ease;
        min-height: 44px;
        justify-content: center;
      }

      .empty-leaderboard {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: var(--text-secondary);
      }

      .empty-icon {
        font-size: 48px;
        margin-bottom: 12px;
        opacity: 0.5;
      }

      .empty-text {
        font-weight: 600;
        margin-bottom: 4px;
      }

      .empty-hint {
        font-size: 0.85rem;
        opacity: 0.7;
      }

      .settings-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px dashed var(--gray-200);
      }
      .settings-row:last-child {
        border-bottom: 0;
      }
      .settings-row span {
        color: var(--sky-500);
        font-weight: 600;
      }
      .toggle {
        appearance: none;
        width: 48px;
        height: 28px;
        border-radius: 999px;
        background: var(--gray-200);
        position: relative;
        cursor: pointer;
        outline: none;
        transition: 0.2s;
      }
      .toggle:checked {
        background: linear-gradient(90deg, var(--sky-400), var(--sky-500));
      }
      .toggle::after {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: #fff;
        transition: 0.2s;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }
      .toggle:checked::after {
        left: 23px;
      }

      @keyframes pulse {
        from {
          transform: scale(1);
        }
        to {
          transform: scale(1.08);
        }
      }
      @media (max-width: 640px) {
        .game-header {
          height: 70px;
          padding-left: var(--space-4);
          padding-right: var(--space-4);
          gap: 12px;
          grid-template-columns: auto 1fr auto auto;
        }
        .game-timer {
          padding: 6px 10px;
          min-width: 70px;
          font-size: 1.3rem;
        }
        .game-mode {
          padding: 6px 12px;
          font-size: 0.8rem;
        }
        .header-tps {
          padding: 6px 12px;
          min-width: 50px;
        }

        /* 手機端模態窗口優化 */
        .modal {
          padding: 20px 16px;
          align-items: flex-start;
          padding-top: max(env(safe-area-inset-top), 40px);
          padding-bottom: max(env(safe-area-inset-bottom), 40px);
        }
        .modal-card {
          max-height: calc(100vh - 80px);
          width: calc(100vw - 32px);
          margin: 0;
          overflow-y: auto;
          -webkit-overflow-scrolling: touch;
        }
        #gameInfoModal .modal-card {
          padding: 20px 16px;
        }

        /* 手機端主選單間距優化 */
        .menu-screen {
          height: auto !important;
          min-height: 100svh;
          padding-top: 4vh;
          padding-bottom: max(env(safe-area-inset-bottom), 16px);
          justify-content: center;
          display: flex;
          flex-direction: column;
          align-items: center;
          overflow-y: auto;
          -webkit-overflow-scrolling: touch;
        }

        /* 只在橫幅出現時才加大 padding-bottom */
        .has-install-banner .menu-screen {
          padding-bottom: calc(max(env(safe-area-inset-bottom), 16px) + 80px);
        }

        .brand {
          margin-bottom: 2vh;
          flex-shrink: 0;
        }

        .brand-title {
          font-size: 2.1rem !important;
          margin-bottom: 0.3rem;
        }

        .brand-subtitle {
          font-size: 0.9rem !important;
          font-weight: 500;
          margin-top: 0.3rem;
        }

        .menu-buttons {
          gap: 1.5vh;
          max-width: 320px;
          width: 90vw;
          flex-shrink: 0;
          display: flex;
          flex-direction: column;
          align-items: center;
        }

        .menu-btn {
          padding: 14px 20px;
          font-size: 0.9rem;
          font-weight: 600;
          width: 100%;
          max-width: 320px;
          min-height: 56px;
        }

        .menu-btn .material-symbols-rounded {
          font-size: 20px;
          margin-right: 8px;
        }

        /* 確保PWA橫幅不影響主內容 */
        .install-banner {
          position: fixed !important;
          bottom: 0;
          left: 0;
          right: 0;
          z-index: 100;
          height: auto;
          max-height: 80px;
          padding: 14px 18px;
        }

        .install-banner .title {
          font-weight: 600 !important;
          font-size: 0.95rem;
        }

        .install-banner .hint {
          font-size: 0.8rem !important;
          font-weight: 400;
        }
        .header-tps .hud-tps-label {
          font-size: 0.55rem;
        }
        .header-tps .hud-tps-value {
          font-size: 0.8rem;
        }
        .game-exit {
          width: 36px;
          height: 36px;
          padding: 6px;
        }
        .app.single .game-area {
          margin-top: calc(70px + env(safe-area-inset-top));
        }
        .score-display {
          font-size: 2.6rem;
        }
        .leaderboard-card {
          max-height: 85vh;
          padding: 16px;
          margin: 10px;
          width: calc(100vw - 20px);
        }
        .leaderboard-header {
          margin-bottom: 16px;
        }
        .leaderboard-title {
          font-size: 1.3rem;
          margin-bottom: 12px;
        }
        .leaderboard-item {
          padding: 10px 12px;
        }
        .rank-badge {
          width: 28px;
          height: 28px;
          font-size: 0.8rem;
          margin-right: 10px;
        }
        .player-name {
          font-size: 0.85rem;
        }
        .score-value {
          font-size: 1rem;
        }
        .pagination {
          padding: 8px;
          margin-top: 12px;
        }
        .page-btn {
          width: 32px;
          height: 32px;
        }
        .leaderboard-actions .btn {
          padding: 8px 12px;
          font-size: 0.85rem;
          min-height: 40px;
        }
      }

      .install-banner {
        position: fixed;
        left: 12px;
        right: 12px;
        bottom: 12px;
        z-index: 1500;
        background: #fff;
        border: 1px solid var(--sky-200);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
        border-radius: 16px;
        padding: 12px 14px;
        display: none;
        gap: 12px;
        align-items: center;
      }
      .install-banner.show {
        display: flex;
      }
      .install-banner .txt {
        flex: 1;
      }
      .install-banner .title {
        font-weight: 900;
        color: var(--gray-700);
      }
      .install-banner .hint {
        font-size: 12px;
        color: var(--text-secondary);
      }
      .install-banner .actions {
        display: flex;
        gap: 8px;
      }
    </style>
  </head>
  <body>
    <div class="app" id="app">
      <!-- 主選單 -->
      <div class="menu-screen" id="menuScreen">
        <div class="brand">
          <div class="brand-icon">
            <svg viewBox="0 0 24 24" width="54" height="54" aria-hidden="true">
              <path
                fill="#f66fb9"
                d="M12 2l2.39 6.26L21 9.27l-5.18 4.87L17.18 21 12 18.26 6.82 21l1.36-6.86L3 9.27l6.61-1.01L12 2z"
              />
            </svg>
          </div>
          <h1 class="brand-title">Bunny Click</h1>
          <div class="brand-subtitle">粉色 × 天藍｜點擊樂趣遊戲</div>
        </div>

        <div class="menu-buttons">
          <button class="menu-btn menu-btn-primary" id="startSingleBtn" aria-label="單人挑戰模式">
            <span class="material-symbols-rounded" aria-hidden="true">person</span>
            單人挑戰模式
          </button>
          <button class="menu-btn menu-btn-primary" id="startDualBtn" aria-label="雙人對戰模式">
            <span class="material-symbols-rounded" aria-hidden="true">groups</span>
            雙人對戰模式
          </button>
          <button class="menu-btn menu-btn-secondary" id="leaderboardBtn" aria-label="排行榜">
            <span class="material-symbols-rounded" aria-hidden="true">leaderboard</span>
            排行榜
          </button>
          <button class="menu-btn menu-btn-secondary" id="settingsBtn" aria-label="遊戲設定">
            <span class="material-symbols-rounded" aria-hidden="true">settings</span>
            遊戲設定
          </button>
          <button class="menu-btn menu-btn-secondary" id="gameInfoBtn" aria-label="遊戲說明">
            <span class="material-symbols-rounded" aria-hidden="true">info</span>
            遊戲說明
          </button>
        </div>
      </div>

      <!-- 遊戲畫面 -->
      <div class="game-screen" id="gameScreen" aria-hidden="true">
        <!-- 單人頂欄 -->
        <div class="game-header" id="gameHeader">
          <div class="game-timer" aria-live="polite">
            <span class="material-symbols-rounded" aria-hidden="true" style="font-size: 22px"
              >timer</span
            >
            <span id="gameTimer">30</span>
          </div>
          <div class="game-mode" id="gameMode">單人模式</div>
          <div class="header-tps" id="headerTps">
            <div class="hud-tps-label">TPS</div>
            <div class="hud-tps-value">0</div>
          </div>
          <button class="game-exit" id="gameExit" aria-label="離開遊戲">
            <span class="material-symbols-rounded" aria-hidden="true">close</span>
          </button>
        </div>

        <div class="game-area" id="gameArea">
          <canvas id="fxCanvas" class="fx"></canvas>

          <div class="single-player-area" id="singlePlayerArea" style="display: none">
            <div class="player-name" id="encouragementText">點擊開始你的挑戰！</div>
            <div class="score-display" id="singleScore">0</div>
          </div>

          <div class="dual-player-area" id="dualPlayerArea" style="display: none">
            <div class="divider"></div>

            <div class="player-zone player1" data-player="1">
              <div class="player-hud">
                <div class="hud-timer" id="hudTimerP1">30</div>
                <div class="hud-mode" id="hudModeP1">雙人對戰</div>
                <div class="hud-tps-wrapper" id="hudTpsP1Wrapper">
                  <div class="hud-tps-container" id="hudTpsP1">
                    <div class="hud-tps-label">TPS</div>
                    <div class="hud-tps-value">0</div>
                  </div>
                </div>
              </div>
              <div class="player-name">玩家 1</div>
              <div class="score-display" id="player1Score">0</div>
            </div>

            <div class="player-zone player2" data-player="2">
              <div class="player-hud">
                <div class="hud-timer" id="hudTimerP2">30</div>
                <div class="hud-mode" id="hudModeP2">雙人對戰</div>
                <div class="hud-tps-wrapper" id="hudTpsP2Wrapper">
                  <div class="hud-tps-container" id="hudTpsP2">
                    <div class="hud-tps-label">TPS</div>
                    <div class="hud-tps-value">0</div>
                  </div>
                </div>
              </div>
              <div class="player-name">玩家 2</div>
              <div class="score-display" id="player2Score">0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 煙火 -->
      <div class="firework-container" id="fireworkContainer"></div>

      <!-- 結果 -->
      <div class="modal" id="resultModal" aria-hidden="true" role="dialog">
        <!-- 單人模式結果 -->
        <div class="modal-card result-card single-result" id="singleResult">
          <div class="result-header">
            <div class="trophy-icon">
              <span class="material-symbols-rounded" style="font-size: 48px; color: #ffd700"
                >trophy</span
              >
            </div>
            <h2 class="result-title" id="resultTitle">遊戲結束！</h2>
            <div class="result-subtitle">恭喜完成挑戰！</div>
          </div>

          <div class="result-stats">
            <div class="stat-item main-score">
              <div class="stat-label">最終得分</div>
              <div class="stat-value" id="resultScore">0</div>
            </div>
            <div class="stat-item tps-stat">
              <div class="stat-label">最高 TPS</div>
              <div class="stat-value tps-value" id="resultTPS">0</div>
            </div>
          </div>

          <div class="achievement-section">
            <div class="achievement-badge" id="achievementBadge">
              <div class="badge-icon">
                <span class="material-symbols-rounded">bolt</span>
              </div>
              <div class="badge-text">點擊大師</div>
            </div>
          </div>

          <div class="result-actions">
            <button class="btn btn-primary result-btn" id="playAgainBtn">
              <span class="material-symbols-rounded">refresh</span>
              再來一局
            </button>
            <button class="btn btn-secondary result-btn" id="backToMenuBtn">
              <span class="material-symbols-rounded">home</span>
              返回主選單
            </button>
          </div>
        </div>

        <!-- 雙人模式結果 -->
        <div class="modal-card dual-result-card" id="dualResult" style="display: none">
          <div class="dual-result-header">
            <div class="winner-crown" id="winnerCrown">
              <span class="material-symbols-rounded" style="font-size: 48px; color: #ffd700"
                >crown</span
              >
            </div>
            <h2 class="dual-result-title" id="dualResultTitle">對戰結果</h2>
            <div class="dual-result-subtitle" id="dualResultSubtitle">激烈的對決！</div>
          </div>

          <div class="players-comparison">
            <div class="player-result player1-result" id="player1Result">
              <div class="player-medal" id="player1Medal">
                <div class="medal-icon">
                  <span class="material-symbols-rounded" style="font-size: 48px; color: #c0c0c0"
                    >military_tech</span
                  >
                </div>
              </div>
              <div class="player-info">
                <div class="player-name">玩家 1</div>
                <div class="player-stats">
                  <div class="player-score">
                    <span class="score-label">得分</span>
                    <span class="score-value" id="player1ResultScore">0</span>
                  </div>
                  <div class="player-tps">
                    <span class="tps-label">最高 TPS</span>
                    <span class="tps-value" id="player1ResultTPS">0</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="vs-divider">
              <div class="vs-text">VS</div>
            </div>

            <div class="player-result player2-result" id="player2Result">
              <div class="player-medal" id="player2Medal">
                <div class="medal-icon">
                  <span class="material-symbols-rounded" style="font-size: 48px; color: #c0c0c0"
                    >military_tech</span
                  >
                </div>
              </div>
              <div class="player-info">
                <div class="player-name">玩家 2</div>
                <div class="player-stats">
                  <div class="player-score">
                    <span class="score-label">得分</span>
                    <span class="score-value" id="player2ResultScore">0</span>
                  </div>
                  <div class="player-tps">
                    <span class="tps-label">最高 TPS</span>
                    <span class="tps-value" id="player2ResultTPS">0</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="dual-achievement-section">
            <div class="dual-achievement-badge" id="dualAchievementBadge">
              <div class="badge-icon">
                <span class="material-symbols-rounded">swords</span>
              </div>
              <div class="badge-text">激戰高手</div>
            </div>
          </div>

          <div class="result-actions">
            <button class="btn btn-primary result-btn" id="playAgainDualBtn">
              <span class="material-symbols-rounded">refresh</span>
              再來一局
            </button>
            <button class="btn btn-secondary result-btn" id="backToMenuDualBtn">
              <span class="material-symbols-rounded">home</span>
              返回主選單
            </button>
          </div>
        </div>
      </div>

      <!-- 排行榜 -->
      <div class="modal" id="leaderboardModal" aria-hidden="true" role="dialog">
        <div class="modal-card leaderboard-card">
          <div class="leaderboard-header">
            <h2 class="leaderboard-title">
              <span class="material-symbols-rounded" style="color: #ffd700; margin-right: 8px"
                >trophy</span
              >
              排行榜
            </h2>
            <div class="leaderboard-tabs">
              <button class="tab-btn active" data-mode="single" data-time="all">單人模式</button>
              <button class="tab-btn" data-mode="dual" data-time="all">雙人對戰</button>
            </div>
            <div class="leaderboard-time-tabs">
              <button class="time-tab-btn active" data-time="all">全部</button>
              <button class="time-tab-btn" data-time="15">15秒</button>
              <button class="time-tab-btn" data-time="30">30秒</button>
              <button class="time-tab-btn" data-time="60">60秒</button>
            </div>
          </div>

          <div class="leaderboard-content">
            <div class="leaderboard-list" id="leaderboardList">
              <!-- 排行榜項目將在這裡動態生成 -->
            </div>

            <div class="pagination" id="leaderboardPagination">
              <button class="page-btn" id="prevPageBtn" disabled>
                <span class="material-symbols-rounded">chevron_left</span>
              </button>
              <div class="page-info">
                <span id="currentPage">1</span> / <span id="totalPages">1</span>
              </div>
              <button class="page-btn" id="nextPageBtn" disabled>
                <span class="material-symbols-rounded">chevron_right</span>
              </button>
            </div>
          </div>

          <div class="leaderboard-actions">
            <button class="btn btn-danger" id="clearLeaderboardBtn">
              <span class="material-symbols-rounded">delete</span>
              清除記錄
            </button>
            <button class="btn btn-secondary" id="closeLeaderboardBtn">
              <span class="material-symbols-rounded">close</span>
              關閉
            </button>
          </div>
        </div>
      </div>

      <!-- 設定 -->
      <div class="modal" id="settingsModal" aria-hidden="true" role="dialog">
        <div class="modal-card" style="max-width: 90vw; width: 560px; text-align: left">
          <h2 class="title-gradient">遊戲設定</h2>
          <div style="margin-top: 12px; display: grid; gap: 10px">
            <div class="settings-row">
              <span>音效開啟</span><input type="checkbox" id="soundEnabled" class="toggle" />
            </div>
            <div class="settings-row">
              <span>震動回饋</span><input type="checkbox" id="vibrationEnabled" class="toggle" />
            </div>
            <div class="settings-row">
              <span>遊戲時間</span>
              <select
                id="gameDuration"
                style="
                  padding: 6px 8px;
                  border-radius: 10px;
                  border: 2px solid var(--sky-300);
                  background: white;
                  color: var(--sky-600);
                  font-weight: 600;
                "
              >
                <option value="15">15 秒</option>
                <option value="30" selected>30 秒</option>
                <option value="60">60 秒</option>
              </select>
            </div>
            <div class="settings-row">
              <span>水波紋動畫</span><input type="checkbox" id="rippleEnabled" class="toggle" />
            </div>
            <div class="settings-row">
              <span>雷電效果</span><input type="checkbox" id="lightningEnabled" class="toggle" />
            </div>
            <div class="settings-row">
              <span>TPS 顯示</span><input type="checkbox" id="showTps" class="toggle" />
            </div>
          </div>
          <!-- 版本資訊 -->
          <div
            style="
              margin-top: 20px;
              padding: 16px;
              background: linear-gradient(135deg, var(--pink-50), var(--sky-50));
              border-radius: 12px;
              border: 1px solid var(--sky-200);
              text-align: center;
            "
          >
            <div style="font-size: 12px; color: var(--sky-600); margin-bottom: 4px">當前版本</div>
            <div
              style="
                font-size: 16px;
                font-weight: 600;
                color: var(--sky-400);
                font-family: 'Courier New', monospace;
              "
              id="versionDisplay"
            >v7.2.3</div>
          </div>
          <div style="display: flex; justify-content: center; margin-top: 18px">
            <button class="btn btn-primary" id="closeSettingsBtn">儲存設定</button>
          </div>
        </div>
      </div>

      <!-- 遊戲說明 -->
      <div class="modal" id="gameInfoModal" aria-hidden="true" role="dialog">
        <div
          class="modal-card"
          style="
            max-width: 90vw;
            width: 720px;
            max-height: 90vh;
            overflow-y: auto;
            text-align: left;
          "
        >
          <h2 class="title-gradient">遊戲說明</h2>

          <div style="margin-top: 20px">
            <h3
              style="
                color: var(--primary);
                margin-bottom: 16px;
                font-size: 1.2rem;
                display: flex;
                align-items: center;
                gap: 8px;
              "
            >
              <span class="material-symbols-rounded">flash_on</span>
              遊戲特色
            </h3>

            <div style="display: grid; gap: 16px; margin-bottom: 24px">
              <div
                style="
                  display: flex;
                  align-items: flex-start;
                  gap: 12px;
                  padding: 12px;
                  background: rgba(246, 111, 185, 0.05);
                  border-radius: 8px;
                "
              >
                <span class="material-symbols-rounded" style="color: var(--accent); font-size: 20px"
                  >speed</span
                >
                <div>
                  <h4 style="margin: 0 0 4px 0; color: var(--text-primary); font-weight: 600">
                    TPS 精確計算
                  </h4>
                  <p
                    style="
                      margin: 0;
                      color: var(--text-secondary);
                      font-size: 0.9rem;
                      line-height: 1.4;
                    "
                  >
                    專業的每秒點擊次數 (TPS) 計算系統，精確測量您的點擊速度表現，助您挑戰極限。
                  </p>
                </div>
              </div>

              <div
                style="
                  display: flex;
                  align-items: flex-start;
                  gap: 12px;
                  padding: 12px;
                  background: rgba(82, 183, 255, 0.05);
                  border-radius: 8px;
                "
              >
                <span
                  class="material-symbols-rounded"
                  style="color: var(--primary); font-size: 20px"
                  >offline_bolt</span
                >
                <div>
                  <h4 style="margin: 0 0 4px 0; color: var(--text-primary); font-weight: 600">
                    PWA 離線支援
                  </h4>
                  <p
                    style="
                      margin: 0;
                      color: var(--text-secondary);
                      font-size: 0.9rem;
                      line-height: 1.4;
                    "
                  >
                    採用先進的 PWA 技術，支援離線遊戲，無需網路連線也能享受流暢的遊戲體驗。
                  </p>
                </div>
              </div>

              <div
                style="
                  display: flex;
                  align-items: flex-start;
                  gap: 12px;
                  padding: 12px;
                  background: rgba(246, 111, 185, 0.05);
                  border-radius: 8px;
                "
              >
                <span class="material-symbols-rounded" style="color: var(--accent); font-size: 20px"
                  >palette</span
                >
                <div>
                  <h4 style="margin: 0 0 4px 0; color: var(--text-primary); font-weight: 600">
                    美觀設計
                  </h4>
                  <p
                    style="
                      margin: 0;
                      color: var(--text-secondary);
                      font-size: 0.9rem;
                      line-height: 1.4;
                    "
                  >
                    獨特的粉色×天藍漸層配色設計，現代化的使用者介面，帶來視覺享受。
                  </p>
                </div>
              </div>

              <div
                style="
                  display: flex;
                  align-items: flex-start;
                  gap: 12px;
                  padding: 12px;
                  background: rgba(82, 183, 255, 0.05);
                  border-radius: 8px;
                "
              >
                <span
                  class="material-symbols-rounded"
                  style="color: var(--primary); font-size: 20px"
                  >devices</span
                >
                <div>
                  <h4 style="margin: 0 0 4px 0; color: var(--text-primary); font-weight: 600">
                    跨平台相容
                  </h4>
                  <p
                    style="
                      margin: 0;
                      color: var(--text-secondary);
                      font-size: 0.9rem;
                      line-height: 1.4;
                    "
                  >
                    完美支援手機、平板、電腦等多種裝置，無需下載安裝，開啟瀏覽器即可開始遊戲。
                  </p>
                </div>
              </div>
            </div>

            <h3
              style="
                color: var(--primary);
                margin-bottom: 16px;
                font-size: 1.2rem;
                display: flex;
                align-items: center;
                gap: 8px;
              "
            >
              <span class="material-symbols-rounded">star</span>
              為什麼選擇 Bunny Click？
            </h3>

            <div style="display: grid; gap: 8px; margin-bottom: 24px">
              <div style="display: flex; align-items: center; gap: 12px; padding: 8px">
                <span class="material-symbols-rounded" style="color: var(--accent); font-size: 18px"
                  >check_circle</span
                >
                <span style="color: var(--text-primary); font-size: 0.9rem"
                  >完全免費，無需註冊或登入</span
                >
              </div>
              <div style="display: flex; align-items: center; gap: 12px; padding: 8px">
                <span class="material-symbols-rounded" style="color: var(--accent); font-size: 18px"
                  >flash_on</span
                >
                <span style="color: var(--text-primary); font-size: 0.9rem"
                  >即時載入，無需等待下載</span
                >
              </div>
              <div style="display: flex; align-items: center; gap: 12px; padding: 8px">
                <span class="material-symbols-rounded" style="color: var(--accent); font-size: 18px"
                  >analytics</span
                >
                <span style="color: var(--text-primary); font-size: 0.9rem"
                  >詳細統計，追蹤遊戲表現</span
                >
              </div>
              <div style="display: flex; align-items: center; gap: 12px; padding: 8px">
                <span class="material-symbols-rounded" style="color: var(--accent); font-size: 18px"
                  >trophy</span
                >
                <span style="color: var(--text-primary); font-size: 0.9rem"
                  >排行榜功能，與好友競爭</span
                >
              </div>
              <div style="display: flex; align-items: center; gap: 12px; padding: 8px">
                <span class="material-symbols-rounded" style="color: var(--accent); font-size: 18px"
                  >group</span
                >
                <span style="color: var(--text-primary); font-size: 0.9rem"
                  >雙人對戰，增加互動樂趣</span
                >
              </div>
              <div style="display: flex; align-items: center; gap: 12px; padding: 8px">
                <span class="material-symbols-rounded" style="color: var(--accent); font-size: 18px"
                  >sync</span
                >
                <span style="color: var(--text-primary); font-size: 0.9rem"
                  >跨裝置同步，隨時隨地遊戲</span
                >
              </div>
            </div>
          </div>

          <div
            style="display: flex; justify-content: center; margin-top: 24px; padding-bottom: 20px"
          >
            <button class="btn btn-primary" id="closeGameInfoBtn">開始遊戲</button>
          </div>
        </div>
      </div>

      <!-- PWA 安裝／教學橫幅 -->
      <div class="install-banner" id="installBanner">
        <div class="txt">
          <div class="title" id="installTitle">安裝 Bunny Click</div>
          <div class="hint" id="installHint">快速啟動、離線遊玩、全螢幕體驗</div>
        </div>
        <div class="actions">
          <button class="btn btn-secondary" id="installDismiss">不再顯示</button>
          <button class="btn btn-primary" id="installAction">安裝</button>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const noop = () => {};
        ['log', 'warn', 'error', 'info', 'debug', 'time', 'timeEnd'].forEach(m => {
          try {
            console[m] = noop;
          } catch (e) {}
        });
      })();

      // ===== 版本管理 =====
      const APP_VERSION = '7.2.3';
      const SW_ENHANCED_VERSION = 'bunny-click-enhanced-v1.1.0';

      // 更新版本號顯示
      function updateVersionDisplay() {
        const versionDisplay = document.getElementById('versionDisplay');
        if (versionDisplay) {
          versionDisplay.textContent = `v${APP_VERSION}`;
        }
      }

      // 當前版本的所有快取名稱模式
      const CURRENT_CACHE_PATTERNS = [
        `bunny-click-v${APP_VERSION}`,
        `${SW_ENHANCED_VERSION}-app-shell`,
        `${SW_ENHANCED_VERSION}-static`,
        `${SW_ENHANCED_VERSION}-dynamic`,
        `${SW_ENHANCED_VERSION}-images`,
      ];

      // ===== 鼓勵文字系統 =====
      const ENCOURAGEMENT_MESSAGES = [
        // 1-5 TPS: 新手鼓勵
        { minTPS: 1, maxTPS: 2, message: '不錯的開始！手指正在熱身中 🔥' },
        { minTPS: 2, maxTPS: 3, message: '感覺到節奏了嗎？繼續保持！ 🎵' },
        { minTPS: 3, maxTPS: 4, message: '你的手指開始跳舞了！💃' },
        { minTPS: 4, maxTPS: 5, message: '穩定的節奏，就像心跳一樣！❤️' },
        { minTPS: 5, maxTPS: 6, message: '手指靈活度 +1！繼續加油！✨' },

        // 6-15 TPS: 進階鼓勵
        { minTPS: 6, maxTPS: 8, message: '哇！你的手指有魔法嗎？🪄' },
        { minTPS: 8, maxTPS: 10, message: '這速度讓螢幕都開始發燙了！🔥' },
        { minTPS: 10, maxTPS: 12, message: '手指變成閃電了！⚡' },
        { minTPS: 12, maxTPS: 15, message: '你是點擊界的鋼琴家！🎹' },
        { minTPS: 15, maxTPS: 18, message: '手速快到模糊了！👻' },

        // 16-30 TPS: 高手級鼓勵
        { minTPS: 18, maxTPS: 20, message: '這是人類的極限嗎？！🚀' },
        { minTPS: 20, maxTPS: 22, message: '手指已經突破音速！💨' },
        { minTPS: 22, maxTPS: 25, message: '你的手指是渦輪增壓的嗎？🏎️' },
        { minTPS: 25, maxTPS: 28, message: '連蜂鳥都自嘆不如！🐦' },
        { minTPS: 28, maxTPS: 30, message: '手指變成光速了！💫' },

        // 31-50 TPS: 超人級鼓勵
        { minTPS: 30, maxTPS: 35, message: '你確定不是機器人嗎？🤖' },
        { minTPS: 35, maxTPS: 40, message: '手指已經進入超次元空間！🌌' },
        { minTPS: 40, maxTPS: 45, message: '這速度連閃電都追不上！⚡⚡' },
        { minTPS: 45, maxTPS: 50, message: '你的手指違反了物理定律！🧪' },
        { minTPS: 50, maxTPS: 55, message: '手指已經超越時空限制！⏰' },

        // 51-70 TPS: 神級鼓勵
        { minTPS: 55, maxTPS: 60, message: '這是傳說中的神之手速！👑' },
        { minTPS: 60, maxTPS: 65, message: '你的手指擁有量子糾纏能力！⚛️' },
        { minTPS: 65, maxTPS: 70, message: '手指已經達到宇宙級頻率！🌟' },
        { minTPS: 70, maxTPS: 75, message: '連時間都為你的速度停止！⏸️' },
        { minTPS: 75, maxTPS: 80, message: '你的手指創造了新的維度！🔮' },

        // 81-100 TPS: 終極鼓勵
        { minTPS: 80, maxTPS: 85, message: '手指已經成為純能量體！💥' },
        { minTPS: 85, maxTPS: 90, message: '你重新定義了「快」這個字！📚' },
        { minTPS: 90, maxTPS: 95, message: '手指速度已經無法用科學解釋！🔬' },
        { minTPS: 95, maxTPS: 100, message: '你就是點擊宇宙的創造者！🌍' },
        { minTPS: 100, maxTPS: Infinity, message: '傳說中的點擊之神降臨！👼' },
      ];

      // 獲取對應 TPS 的鼓勵文字
      function getEncouragementMessage(tps) {
        for (const msg of ENCOURAGEMENT_MESSAGES) {
          if (tps >= msg.minTPS && tps < msg.maxTPS) {
            return msg.message;
          }
        }
        return ENCOURAGEMENT_MESSAGES[ENCOURAGEMENT_MESSAGES.length - 1].message;
      }

      // 版本檢測和自動更新
      async function checkForUpdates() {
        if ('serviceWorker' in navigator) {
          try {
            const registration = await navigator.serviceWorker.ready;
            if (registration.active) {
              // 檢查本地存儲的版本
              const storedVersion = localStorage.getItem('app_version');
              if (storedVersion && storedVersion !== APP_VERSION) {
                console.log(`版本更新：${storedVersion} → ${APP_VERSION}`);

                // 顯示版本更新提示
                showVersionUpdateToast(storedVersion, APP_VERSION);

                // 清除舊版本快取
                if ('caches' in window) {
                  const cacheNames = await caches.keys();
                  await Promise.all(
                    cacheNames.map(cacheName => {
                      // 檢查是否為當前版本的快取
                      const isCurrentVersion = CURRENT_CACHE_PATTERNS.includes(cacheName);

                      if (!isCurrentVersion) {
                        console.log(`清除舊快取: ${cacheName}`);
                        return caches.delete(cacheName);
                      } else {
                        console.log(`保留當前快取: ${cacheName}`);
                      }
                    })
                  );
                }
                // 更新版本號
                localStorage.setItem('app_version', APP_VERSION);

                // 延遲重新載入，讓用戶看到更新提示
                setTimeout(() => {
                  window.location.reload();
                }, 3000);
                return;
              }
              // 首次安裝或版本相同
              localStorage.setItem('app_version', APP_VERSION);
            }
          } catch (error) {
            console.log('版本檢測失敗:', error);
          }
        }
      }

      // 顯示版本更新提示
      function showVersionUpdateToast(oldVersion, newVersion) {
        const toast = document.createElement('div');
        toast.className = 'version-update-toast';
        toast.innerHTML = `
          <div class="toast-content">
            <div class="toast-icon">
              <span class="material-symbols-rounded" style="color: #ffd700;">celebration</span>
            </div>
            <div class="toast-text">
              <div class="toast-title">版本更新檢測到！</div>
              <div class="toast-subtitle">從 v${oldVersion} 更新至 v${newVersion}</div>
            </div>
            <button class="toast-close" onclick="this.parentElement.parentElement.remove()">×</button>
          </div>
        `;

        document.body.appendChild(toast);

        // 3秒後自動消失
        setTimeout(() => {
          if (toast.parentElement) {
            toast.remove();
          }
        }, 3000);
      }

      // ===== 遊戲狀態 =====
      const GameState = {
        isPlaying: false,
        hasStarted: false, // 是否已經開始計時
        mode: 'single',
        timeLeft: 30,
        scores: { single: 0, player1: 0, player2: 0 },
        settings: {
          soundEnabled: true,
          vibrationEnabled: true,
          gameDuration: 30,
          rippleEnabled: true,
          lightningEnabled: true,
          showTps: true,
        },
        pointers: new Map(),
        activePointers: new Map(),
        lastTapTime: { single: 0, player1: 0, player2: 0 },
        tpsEMA: { single: 0, player1: 0, player2: 0 },
        tapTimestamps: { single: [], player1: [], player2: [] },
        tpsUpdateInterval: null,
        maxTPS: { single: 0, player1: 0, player2: 0 },
        tapQueues: [],
        inputLockUntil: 0,
        ultraSpeedTimeout: null,
        ultraSpeedTimeout1: null,
        ultraSpeedTimeout2: null,
      };

      const SPEED_STEP = 0.5; // 每 0.5 TPS 一級，總共 10 級（越高越炫）
      const tpsToLevel = tps => Math.max(1, Math.min(10, Math.floor(tps / SPEED_STEP) + 1));

      // 正確的 TPS 計算函數 - 基於滑動窗口
      function calculateRealTPS(playerId) {
        const now = performance.now();
        const timestamps = GameState.tapTimestamps[playerId];

        // 清除超過1秒的舊記錄
        while (timestamps.length > 0 && now - timestamps[0] > 1000) {
          timestamps.shift();
        }

        return timestamps.length;
      }

      // 更新所有玩家的 TPS 顯示
      function updateAllTPS() {
        if (!GameState.settings.showTps || !GameState.isPlaying) return;

        const players = GameState.mode === 'single' ? ['single'] : ['player1', 'player2'];

        players.forEach(playerId => {
          const realTPS = calculateRealTPS(playerId);
          GameState.tpsEMA[playerId] = realTPS; // 直接使用真實 TPS，不需要 EMA 平滑

          // 記錄最高 TPS 峰值
          if (realTPS > GameState.maxTPS[playerId]) {
            GameState.maxTPS[playerId] = realTPS;
          }
        });

        uiManager.updateTpsHUD();
      }
      let fxWorker = null,
        fxCanvas = null,
        offscreen = null,
        dpr = 1;
      const isLowPower =
        ('connection' in navigator && navigator.connection && navigator.connection.saveData) ||
        false;

      // ===== FX Worker 初始化 =====
      function setupWorker() {
        // 防止重複初始化
        if (offscreen || fxWorker) {
          console.log('Worker already initialized, skipping...');
          return;
        }

        fxCanvas = document.getElementById('fxCanvas');
        if (!fxCanvas) {
          console.error('Canvas initialization failed');
          return;
        }

        dpr = Math.min(isLowPower ? 1.25 : 1.6, window.devicePixelRatio || 1);

        try {
          if ('OffscreenCanvas' in window && fxCanvas.transferControlToOffscreen) {
            offscreen = fxCanvas.transferControlToOffscreen();
            fxWorker = new Worker('./fx.worker.js', { type: 'module' });
            fxWorker.postMessage({ type: 'init', canvas: offscreen, dpr, lowPower: isLowPower }, [
              offscreen,
            ]);
          } else {
            fxWorker = new Worker('./fx.worker.js', { type: 'module' });
            fxWorker.postMessage({ type: 'init-fallback' }, []);
          }
          resizeFx();
          sendSettingsToWorker();
        } catch (error) {
          console.error('Worker setup failed: [ERROR FILTERED]');
          // 回退到非 OffscreenCanvas 模式
          if (!fxWorker) {
            fxWorker = new Worker('./fx.worker.js', { type: 'module' });
            fxWorker.postMessage({ type: 'init-fallback' }, []);
            resizeFx();
            sendSettingsToWorker();
          }
        }
      }
      function resizeFx() {
        const r = fxCanvas.getBoundingClientRect();
        if (offscreen) {
          fxWorker.postMessage({
            type: 'resize',
            width: r.width,
            height: r.height,
            dpr,
          });
        } else {
          fxCanvas.width = Math.floor(r.width * dpr);
          fxCanvas.height = Math.floor(r.height * dpr);
          fxWorker.postMessage({
            type: 'resize',
            width: r.width,
            height: r.height,
            dpr,
          });
        }
      }
      window.addEventListener('resize', resizeFx);
      function sendSettingsToWorker() {
        fxWorker &&
          fxWorker.postMessage({
            type: 'config',
            rippleEnabled: GameState.settings.rippleEnabled,
            lightningEnabled: GameState.settings.lightningEnabled,
          });
      }

      // ===== 音效管理 =====
      class AdvancedAudioManager {
        constructor() {
          this.audioContext = null;
          this.masterGain = null;
          this.sounds = {};
          this.isInitialized = false;
        }
        async init() {
          if (this.isInitialized) return;
          try {
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)({
              latencyHint: 'interactive',
              sampleRate: 44100,
            });
            this.masterGain = this.audioContext.createGain();
            this.masterGain.connect(this.audioContext.destination);
            if (this.audioContext.state === 'suspended') await this.audioContext.resume();
            const sr = this.audioContext.sampleRate;
            this.sounds.tap = this.renderTap(sr);
            this.sounds.countdown = this.renderBeep(sr);
            this.sounds.victory = this.renderVictory(sr);
            this.sounds.firework = this.renderFirework(sr);
            this.isInitialized = true;
          } catch (e) {}
        }
        renderTap(sr) {
          const n = Math.floor(sr * 0.06),
            b = this.audioContext.createBuffer(1, n, sr),
            d = b.getChannelData(0);
          for (let i = 0; i < n; i++) {
            const t = i / sr;
            d[i] = Math.sin(2 * Math.PI * (900 - 400 * t) * t) * Math.exp(-t * 28) * 0.35;
          }
          return b;
        }
        renderBeep(sr) {
          const n = Math.floor(sr * 0.18),
            b = this.audioContext.createBuffer(1, n, sr),
            d = b.getChannelData(0);
          for (let i = 0; i < n; i++) {
            const t = i / sr;
            d[i] = Math.sin(2 * Math.PI * 1000 * t) * Math.exp(-t * 12) * 0.4;
          }
          return b;
        }
        renderVictory(sr) {
          const n = Math.floor(sr * 0.9),
            b = this.audioContext.createBuffer(2, n, sr);
          const m = [261.63, 329.63, 392, 523.25, 659.25, 784];
          for (let c = 0; c < 2; c++) {
            const d = b.getChannelData(c);
            for (let i = 0; i < n; i++) {
              const t = i / sr,
                idx = Math.floor(t * 6) % m.length;
              d[i] = Math.sin(2 * Math.PI * m[idx] * t) * Math.max(0, 1 - t) * 0.24;
            }
          }
          return b;
        }
        renderFirework(sr) {
          const n = Math.floor(sr * 0.35),
            b = this.audioContext.createBuffer(2, n, sr);
          for (let c = 0; c < 2; c++) {
            const d = b.getChannelData(c);
            for (let i = 0; i < n; i++) {
              const t = i / sr;
              d[i] = (Math.random() - 0.5) * 2 * Math.exp(-t * 10) * 0.3;
            }
          }
          return b;
        }
        play(name, vol = 1) {
          if (!this.isInitialized || !GameState.settings.soundEnabled) return;
          const buf = this.sounds[name];
          if (!buf) return;
          try {
            const src = this.audioContext.createBufferSource();
            const g = this.audioContext.createGain();
            g.gain.value = vol;
            src.buffer = buf;
            src.connect(g);
            g.connect(this.masterGain);
            src.start();
          } catch (e) {}
        }
        vibrate(ms = 40) {
          if (!GameState.settings.vibrationEnabled) return;
          if ('vibrate' in navigator) {
            try {
              navigator.vibrate(ms);
            } catch (e) {}
          }
        }
      }

      // ===== 儲存管理 =====
      class StorageManager {
        constructor() {
          this.KEY = 'eliteTapBattle_FineLightning_PWA_v3';
          this.loadSettings();
        }
        loadSettings() {
          try {
            const d = JSON.parse(localStorage.getItem(this.KEY) || '{}');
            if (d.settings) Object.assign(GameState.settings, d.settings);
          } catch (_) {}
        }
        saveSettings() {
          const d = this.loadData();
          d.settings = { ...GameState.settings };
          this.saveData(d);
        }
        saveScore(mode, score, score2 = null, maxTPS = null) {
          const d = this.loadData();
          const rec = {
            mode,
            score,
            score2,
            maxTPS,
            duration: GameState.settings.gameDuration,
            date: new Date().toISOString(),
            ts: Date.now(),
          };
          d.leaderboard = d.leaderboard || [];
          d.leaderboard.push(rec);
          d.leaderboard.sort((a, b) => b.score - a.score);
          d.leaderboard = d.leaderboard.slice(0, 100); // 增加到100條記錄
          this.saveData(d);
        }
        getLeaderboard(mode = null, duration = null, limit = 10) {
          const d = this.loadData();
          let r = d.leaderboard || [];
          if (mode) r = r.filter(x => x.mode === mode);
          if (duration && duration !== 'all') r = r.filter(x => x.duration === parseInt(duration));
          return r.slice(0, limit);
        }
        clearData() {
          if (confirm('確定要清除所有遊戲記錄嗎？')) {
            localStorage.removeItem(this.KEY);
            alert('記錄已清除！');
          }
        }
        loadData() {
          try {
            return JSON.parse(localStorage.getItem(this.KEY) || '{}');
          } catch (_) {
            return {};
          }
        }
        saveData(d) {
          try {
            localStorage.setItem(this.KEY, JSON.stringify(d));
          } catch (_) {
            alert('儲存空間已滿，請清除舊記錄！');
          }
        }
      }

      // ===== UI 管理 =====
      class AdvancedUIManager {
        constructor() {
          this.encouragementTimeout = null;
          document.getElementById('startSingleBtn').addEventListener('click', async () => {
            // 延遲初始化重型效果
            setupWorker();
            await this.initAudio();
            gameEngine.startSinglePlayer();
          });
          document.getElementById('startDualBtn').addEventListener('click', async () => {
            // 延遲初始化重型效果
            setupWorker();
            await this.initAudio();
            gameEngine.startDualPlayer();
          });
          document.getElementById('leaderboardBtn').addEventListener('click', () => {
            this.currentLeaderboardMode = 'single';
            this.currentLeaderboardPage = 1;
            this.currentLeaderboardDuration = 'all';
            this.updateLeaderboard('single', 1, 'all');
            this.showModal('leaderboardModal');
            this.updateLeaderboardTabs();
            this.updateTimeTabsUI();
          });
          document.getElementById('settingsBtn').addEventListener('click', () => {
            this.showSettings();
          });
          document.getElementById('gameInfoBtn').addEventListener('click', () => {
            this.showModal('gameInfoModal');
          });

          document
            .getElementById('gameExit')
            .addEventListener('click', () => gameEngine.exitGame());
          document.getElementById('playAgainBtn').addEventListener('click', () => {
            this.hideModal('resultModal');
            if (GameState.mode === 'single') gameEngine.startSinglePlayer();
            else gameEngine.startDualPlayer();
          });
          document.getElementById('backToMenuBtn').addEventListener('click', () => {
            this.hideModal('resultModal');
            gameEngine.exitGame();
          });

          // 雙人模式按鈕事件監聽器
          document.getElementById('playAgainDualBtn').addEventListener('click', () => {
            this.hideModal('resultModal');
            gameEngine.startDualPlayer();
          });
          document.getElementById('backToMenuDualBtn').addEventListener('click', () => {
            this.hideModal('resultModal');
            gameEngine.exitGame();
          });

          document
            .getElementById('closeLeaderboardBtn')
            .addEventListener('click', () => this.hideModal('leaderboardModal'));
          document.getElementById('clearLeaderboardBtn').addEventListener('click', () => {
            if (confirm('確定要清除所有記錄嗎？此操作無法復原。')) {
              storageManager.clearData();
              this.updateLeaderboard(
                this.currentLeaderboardMode || 'single',
                1,
                this.currentLeaderboardDuration || 'all'
              );
            }
          });

          // 排行榜分頁和標籤事件
          this.setupLeaderboardEvents();

          document.getElementById('closeSettingsBtn').addEventListener('click', () => {
            this.saveSettings();
            this.hideModal('settingsModal');
            sendSettingsToWorker();
          });
          document.getElementById('closeGameInfoBtn').addEventListener('click', () => {
            this.hideModal('gameInfoModal');
          });

          document.addEventListener('keydown', e => {
            if (e.code === 'Escape' && GameState.isPlaying) gameEngine.exitGame();
          });

          this.loadSettingsUI();
          this.setupPWAInstallBanner();
        }
        async initAudio() {
          if (!audioManager.isInitialized) await audioManager.init();
        }
        showGameScreen(mode) {
          document.getElementById('menuScreen').classList.add('hidden');
          const gs = document.getElementById('gameScreen');
          gs.classList.add('active');
          gs.setAttribute('aria-hidden', 'false');
          if (mode === 'single') {
            document.getElementById('singlePlayerArea').style.display = 'flex';
            document.getElementById('dualPlayerArea').style.display = 'none';
            // 重置鼓勵文字
            const encouragementEl = document.getElementById('encouragementText');
            if (encouragementEl) {
              encouragementEl.textContent = '點擊開始你的挑戰！';
            }
          } else {
            document.getElementById('singlePlayerArea').style.display = 'none';
            document.getElementById('dualPlayerArea').style.display = 'grid';
          }
        }
        showMenuScreen() {
          document.getElementById('menuScreen').classList.remove('hidden');
          const gs = document.getElementById('gameScreen');
          gs.classList.remove('active');
          gs.setAttribute('aria-hidden', 'true');
        }
        updateGameUI() {
          document.getElementById('gameMode').textContent =
            GameState.mode === 'single' ? '單人挑戰' : '雙人對戰';
          document.getElementById('hudModeP1').textContent = '雙人對戰';
          document.getElementById('hudModeP2').textContent = '雙人對戰';
          this.applyTpsToggle();
        }
        updateScoreDisplay() {
          if (GameState.mode === 'single') {
            document.getElementById('singleScore').textContent = GameState.scores.single;
          } else {
            document.getElementById('player1Score').textContent = GameState.scores.player1;
            document.getElementById('player2Score').textContent = GameState.scores.player2;
          }
        }
        animateScore(playerId) {
          const el = document.getElementById(`${playerId}Score`);
          if (!el) return;
          el.style.animation = 'none';
          el.offsetHeight;
          el.style.animation = 'pulse .28s ease-in-out alternate';
        }
        updateTimer() {
          const t = Math.ceil(GameState.timeLeft);
          const tEl = document.getElementById('gameTimer');
          tEl.textContent = t;
          if (GameState.timeLeft <= 5 && GameState.timeLeft > 0) {
            tEl.style.color = 'var(--sky-600)';
            tEl.style.animation = 'pulse .5s ease-in-out infinite alternate';
          } else {
            tEl.style.color = 'var(--primary)';
            tEl.style.animation = '';
          }
          document.getElementById('hudTimerP1').textContent = t;
          document.getElementById('hudTimerP2').textContent = t;
          this.updateTpsHUD();
        }

        updateEncouragementText(currentTPS) {
          const textEl = document.getElementById('encouragementText');
          if (!textEl) return;

          const message = getEncouragementMessage(currentTPS);

          // 只有在文字改變時才更新，並顯示至少1秒
          if (textEl.textContent !== message) {
            textEl.textContent = message;

            // 添加閃爍效果
            textEl.style.animation = 'none';
            textEl.offsetHeight; // 強制重繪
            textEl.style.animation = 'pulse 0.5s ease-in-out';

            // 確保顯示至少1秒
            clearTimeout(this.encouragementTimeout);
            this.encouragementTimeout = setTimeout(() => {
              // 1秒後可以更新為新的文字
            }, 1000);
          }
        }
        updateTpsHUD() {
          if (!GameState.settings.showTps) return;
          const p1Wrapper = document.getElementById('hudTpsP1Wrapper'),
            p2Wrapper = document.getElementById('hudTpsP2Wrapper'),
            headerTps = document.getElementById('headerTps');

          if (GameState.mode === 'single') {
            const tps = GameState.tpsEMA.single;
            const tpsDisplay = Math.min(99999, Math.round(tps * 10) / 10);
            const valueEl = headerTps.querySelector('.hud-tps-value');
            valueEl.textContent = tpsDisplay;

            // 添加高 TPS 漸層文字效果
            if (tps > 30) {
              valueEl.classList.add('high-tps');
            } else {
              valueEl.classList.remove('high-tps');
            }

            // 30TPS以上觸發RGB動畫效果，並至少持續顯示1秒
            if (tps > 30) {
              headerTps.classList.add('ultra-speed');
              // 設置最短顯示時間1秒
              if (GameState.ultraSpeedTimeout) {
                clearTimeout(GameState.ultraSpeedTimeout);
              }
              GameState.ultraSpeedTimeout = setTimeout(() => {
                if (GameState.tpsEMA.single <= 30) {
                  headerTps.classList.remove('ultra-speed');
                }
              }, 1000);
            } else if (!GameState.ultraSpeedTimeout) {
              headerTps.classList.remove('ultra-speed');
            }
          } else {
            const tps1 = GameState.tpsEMA.player1;
            const tps2 = GameState.tpsEMA.player2;
            const tps1Display = Math.min(99999, Math.round(tps1 * 10) / 10);
            const tps2Display = Math.min(99999, Math.round(tps2 * 10) / 10);

            const p1 = document.getElementById('hudTpsP1');
            const p2 = document.getElementById('hudTpsP2');
            const value1El = p1.querySelector('.hud-tps-value');
            const value2El = p2.querySelector('.hud-tps-value');

            value1El.textContent = tps1Display;
            value2El.textContent = tps2Display;

            // Player 1 - 30TPS以上觸發RGB動畫效果，並至少持續顯示1秒
            if (tps1 > 30) {
              p1Wrapper.classList.add('ultra-speed');
              if (GameState.ultraSpeedTimeout1) {
                clearTimeout(GameState.ultraSpeedTimeout1);
              }
              GameState.ultraSpeedTimeout1 = setTimeout(() => {
                if (GameState.tpsEMA.player1 <= 30) {
                  p1Wrapper.classList.remove('ultra-speed');
                }
              }, 1000);
            } else if (!GameState.ultraSpeedTimeout1) {
              p1Wrapper.classList.remove('ultra-speed');
            }

            // Player 2 - 30TPS以上觸發RGB動畫效果，並至少持續顯示1秒
            if (tps2 > 30) {
              p2Wrapper.classList.add('ultra-speed');
              if (GameState.ultraSpeedTimeout2) {
                clearTimeout(GameState.ultraSpeedTimeout2);
              }
              GameState.ultraSpeedTimeout2 = setTimeout(() => {
                if (GameState.tpsEMA.player2 <= 30) {
                  p2Wrapper.classList.remove('ultra-speed');
                }
              }, 1000);
            } else if (!GameState.ultraSpeedTimeout2) {
              p2Wrapper.classList.remove('ultra-speed');
            }
          }
        }
        applyTpsToggle() {
          const el1 = document.getElementById('hudTpsP1Wrapper'),
            el2 = document.getElementById('hudTpsP2Wrapper'),
            headerTps = document.getElementById('headerTps');
          if (GameState.settings.showTps) {
            if (el1) el1.classList.add('show');
            if (el2) el2.classList.add('show');
            if (headerTps) headerTps.style.display = 'flex';
          } else {
            if (el1) el1.classList.remove('show');
            if (el2) el2.classList.remove('show');
            if (headerTps) headerTps.style.display = 'none';
          }
        }
        showResult(r) {
          const modal = document.getElementById('resultModal');
          const singleResult = document.getElementById('singleResult');
          const dualResult = document.getElementById('dualResult');

          if (GameState.mode === 'single') {
            // 顯示單人模式結果
            singleResult.style.display = 'block';
            dualResult.style.display = 'none';

            const title = document.getElementById('resultTitle');
            const score = document.getElementById('resultScore');
            const tpsDiv = document.getElementById('resultTPS');
            const badge = document.getElementById('achievementBadge');

            title.textContent = '單人挑戰完成！';
            score.textContent = r.score;
            tpsDiv.textContent = (Math.round(GameState.maxTPS.single * 10) / 10).toFixed(1);

            // 根據成績設置成就徽章
            if (GameState.maxTPS.single >= 50) {
              badge.innerHTML =
                '<div class="badge-icon"><span class="material-symbols-rounded">rocket_launch</span></div><div class="badge-text">超音速大師</div>';
            } else if (GameState.maxTPS.single >= 30) {
              badge.innerHTML =
                '<div class="badge-icon"><span class="material-symbols-rounded">bolt</span></div><div class="badge-text">閃電快手</div>';
            } else if (GameState.maxTPS.single >= 20) {
              badge.innerHTML =
                '<div class="badge-icon"><span class="material-symbols-rounded">local_fire_department</span></div><div class="badge-text">點擊高手</div>';
            } else {
              badge.innerHTML =
                '<div class="badge-icon"><span class="material-symbols-rounded">star</span></div><div class="badge-text">初露鋒芒</div>';
            }
          } else {
            // 顯示雙人模式結果
            singleResult.style.display = 'none';
            dualResult.style.display = 'block';

            const dualTitle = document.getElementById('dualResultTitle');
            const dualSubtitle = document.getElementById('dualResultSubtitle');
            const winnerCrown = document.getElementById('winnerCrown');

            const player1Result = document.getElementById('player1Result');
            const player2Result = document.getElementById('player2Result');
            const player1Medal = document.getElementById('player1Medal');
            const player2Medal = document.getElementById('player2Medal');

            const player1ScoreEl = document.getElementById('player1ResultScore');
            const player2ScoreEl = document.getElementById('player2ResultScore');
            const player1TPSEl = document.getElementById('player1ResultTPS');
            const player2TPSEl = document.getElementById('player2ResultTPS');

            const dualBadge = document.getElementById('dualAchievementBadge');

            // 設置分數和TPS
            player1ScoreEl.textContent = r.score;
            player2ScoreEl.textContent = r.score2;
            player1TPSEl.textContent = (Math.round(GameState.maxTPS.player1 * 10) / 10).toFixed(1);
            player2TPSEl.textContent = (Math.round(GameState.maxTPS.player2 * 10) / 10).toFixed(1);

            // 重置樣式
            player1Result.classList.remove('winner');
            player2Result.classList.remove('winner');

            // 設置獲勝者
            if (r.winner) {
              dualTitle.textContent = `${r.winner === 'player1' ? '玩家 1' : '玩家 2'} 獲勝！`;
              dualSubtitle.textContent = '恭喜獲得勝利！';
              winnerCrown.style.display = 'block';

              if (r.winner === 'player1') {
                player1Result.classList.add('winner');
                player1Medal.innerHTML =
                  '<div class="medal-icon"><span class="material-symbols-rounded" style="font-size: 48px; color: #ffd700;">military_tech</span></div>';
                player2Medal.innerHTML =
                  '<div class="medal-icon"><span class="material-symbols-rounded" style="font-size: 48px; color: #c0c0c0;">military_tech</span></div>';
              } else {
                player2Result.classList.add('winner');
                player1Medal.innerHTML =
                  '<div class="medal-icon"><span class="material-symbols-rounded" style="font-size: 48px; color: #c0c0c0;">military_tech</span></div>';
                player2Medal.innerHTML =
                  '<div class="medal-icon"><span class="material-symbols-rounded" style="font-size: 48px; color: #ffd700;">military_tech</span></div>';
              }
            } else {
              dualTitle.textContent = '平手對決！';
              dualSubtitle.textContent = '勢均力敵的較量！';
              winnerCrown.style.display = 'none';
              player1Medal.innerHTML =
                '<div class="medal-icon"><span class="material-symbols-rounded" style="font-size: 48px; color: var(--accent);">handshake</span></div>';
              player2Medal.innerHTML =
                '<div class="medal-icon"><span class="material-symbols-rounded" style="font-size: 48px; color: var(--accent);">handshake</span></div>';
            }

            // 設置成就徽章
            const maxTPS = Math.max(GameState.maxTPS.player1, GameState.maxTPS.player2);
            if (maxTPS >= 50) {
              dualBadge.innerHTML =
                '<div class="badge-icon"><span class="material-symbols-rounded">crown</span></div><div class="badge-text">對戰王者</div>';
            } else if (maxTPS >= 30) {
              dualBadge.innerHTML =
                '<div class="badge-icon"><span class="material-symbols-rounded">swords</span></div><div class="badge-text">激戰高手</div>';
            } else if (maxTPS >= 20) {
              dualBadge.innerHTML =
                '<div class="badge-icon"><span class="material-symbols-rounded">local_fire_department</span></div><div class="badge-text">點擊達人</div>';
            } else {
              dualBadge.innerHTML =
                '<div class="badge-icon"><span class="material-symbols-rounded">handshake</span></div><div class="badge-text">友誼第一</div>';
            }
          }

          modal.classList.add('show');
          modal.setAttribute('aria-hidden', 'false');
        }
        showModal(id) {
          const m = document.getElementById(id);
          m.classList.add('show');
          m.setAttribute('aria-hidden', 'false');
        }
        hideModal(id) {
          const m = document.getElementById(id);
          m.classList.remove('show');
          m.setAttribute('aria-hidden', 'true');
        }
        showSettings() {
          document.getElementById('soundEnabled').checked = GameState.settings.soundEnabled;
          document.getElementById('vibrationEnabled').checked = GameState.settings.vibrationEnabled;
          document.getElementById('gameDuration').value = GameState.settings.gameDuration;
          document.getElementById('rippleEnabled').checked = GameState.settings.rippleEnabled;
          document.getElementById('lightningEnabled').checked = GameState.settings.lightningEnabled;
          document.getElementById('showTps').checked = GameState.settings.showTps;
          this.showModal('settingsModal');
        }
        saveSettings() {
          GameState.settings.soundEnabled = document.getElementById('soundEnabled').checked;
          GameState.settings.vibrationEnabled = document.getElementById('vibrationEnabled').checked;
          GameState.settings.gameDuration = parseInt(
            document.getElementById('gameDuration').value,
            10
          );
          GameState.settings.rippleEnabled = document.getElementById('rippleEnabled').checked;
          GameState.settings.lightningEnabled = document.getElementById('lightningEnabled').checked;
          GameState.settings.showTps = document.getElementById('showTps').checked;
          storageManager.saveSettings();
          this.applyTpsToggle();
          sendSettingsToWorker();
        }
        loadSettingsUI() {
          document.getElementById('soundEnabled').checked = GameState.settings.soundEnabled;
          document.getElementById('vibrationEnabled').checked = GameState.settings.vibrationEnabled;
          document.getElementById('gameDuration').value = GameState.settings.gameDuration;
          document.getElementById('rippleEnabled').checked = GameState.settings.rippleEnabled;
          document.getElementById('lightningEnabled').checked = GameState.settings.lightningEnabled;
          document.getElementById('showTps').checked = GameState.settings.showTps;
          this.applyTpsToggle();
        }
        updateLeaderboard(mode = 'single', page = 1, duration = 'all') {
          const itemsPerPage = 8;
          const list = document.getElementById('leaderboardList');
          const currentPageEl = document.getElementById('currentPage');
          const totalPagesEl = document.getElementById('totalPages');
          const prevBtn = document.getElementById('prevPageBtn');
          const nextBtn = document.getElementById('nextPageBtn');

          // 獲取指定模式和時間的記錄
          const allRecords = storageManager.getLeaderboard(mode, duration, 100);
          const totalPages = Math.max(1, Math.ceil(allRecords.length / itemsPerPage));
          const startIndex = (page - 1) * itemsPerPage;
          const records = allRecords.slice(startIndex, startIndex + itemsPerPage);

          // 更新分頁信息
          currentPageEl.textContent = page;
          totalPagesEl.textContent = totalPages;
          prevBtn.disabled = page <= 1;
          nextBtn.disabled = page >= totalPages;

          // 渲染記錄列表
          if (records.length === 0) {
            list.innerHTML = `
              <div class="empty-leaderboard">
                <div class="empty-icon">
                  <span class="material-symbols-rounded" style="font-size: 48px; opacity: 0.5;">trophy</span>
                </div>
                <div class="empty-text">暫無記錄</div>
                <div class="empty-hint">開始遊戲來創造你的第一個記錄吧！</div>
              </div>
            `;
            return;
          }

          list.innerHTML = records
            .map((record, index) => {
              const globalRank = startIndex + index + 1;
              const date = new Date(record.date).toLocaleDateString('zh-TW', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
              });

              let rankClass = 'rank-other';
              if (globalRank === 1) rankClass = 'rank-1';
              else if (globalRank === 2) rankClass = 'rank-2';
              else if (globalRank === 3) rankClass = 'rank-3';

              const scoreText =
                record.score2 != null ? `${record.score} : ${record.score2}` : record.score;

              const tpsText = record.maxTPS ? `最高 TPS: ${record.maxTPS}` : '';

              return `
              <div class="leaderboard-item">
                <div class="rank-badge ${rankClass}">${globalRank}</div>
                <div class="player-info">
                  <div class="player-name">${
                    record.mode === 'single' ? '單人挑戰' : '雙人對戰'
                  }${record.duration ? ` (${record.duration}秒)` : ''}</div>
                  <div class="player-date">${date}</div>
                </div>
                <div class="score-info">
                  <div class="score-value">${scoreText}</div>
                  ${tpsText ? `<div class="tps-info">${tpsText}</div>` : ''}
                </div>
              </div>
            `;
            })
            .join('');

          // 存儲當前狀態
          this.currentLeaderboardMode = mode;
          this.currentLeaderboardPage = page;
          this.currentLeaderboardDuration = duration;
        }

        setupLeaderboardEvents() {
          // 模式標籤切換
          document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const mode = btn.dataset.mode;
              this.currentLeaderboardMode = mode;
              this.currentLeaderboardPage = 1;
              this.updateLeaderboard(mode, 1, this.currentLeaderboardDuration || 'all');
              this.updateLeaderboardTabs();
            });
          });

          // 時間標籤切換
          document.querySelectorAll('.time-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const duration = btn.dataset.time;
              this.currentLeaderboardDuration = duration;
              this.currentLeaderboardPage = 1;
              this.updateLeaderboard(this.currentLeaderboardMode || 'single', 1, duration);
              this.updateTimeTabsUI();
            });
          });

          // 分頁按鈕
          document.getElementById('prevPageBtn').addEventListener('click', () => {
            if (this.currentLeaderboardPage > 1) {
              this.currentLeaderboardPage--;
              this.updateLeaderboard(
                this.currentLeaderboardMode,
                this.currentLeaderboardPage,
                this.currentLeaderboardDuration
              );
            }
          });

          document.getElementById('nextPageBtn').addEventListener('click', () => {
            this.currentLeaderboardPage++;
            this.updateLeaderboard(
              this.currentLeaderboardMode,
              this.currentLeaderboardPage,
              this.currentLeaderboardDuration
            );
          });
        }

        updateLeaderboardTabs() {
          document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === this.currentLeaderboardMode);
          });
        }

        updateTimeTabsUI() {
          document.querySelectorAll('.time-tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.time === this.currentLeaderboardDuration);
          });
        }

        // PWA 安裝提示
        setupPWAInstallBanner() {
          const banner = document.getElementById('installBanner');
          const title = document.getElementById('installTitle');
          const hint = document.getElementById('installHint');
          const btnInstall = document.getElementById('installAction');
          const btnDismiss = document.getElementById('installDismiss');
          const DISMISS_KEY = 'etb_install_dismiss_v1';
          if (localStorage.getItem(DISMISS_KEY) === '1') return;
          const isStandalone =
            window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
          if (isStandalone) return;
          const isiOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
          let deferredPrompt = null;
          if (!isiOS) {
            window.addEventListener('beforeinstallprompt', e => {
              e.preventDefault();
              deferredPrompt = e;
              title.textContent = '安裝 Bunny Click';
              hint.textContent = '支援離線、啟動更快、全螢幕體驗';
              btnInstall.textContent = '安裝';
              banner.classList.add('show');
              document.documentElement.classList.add('has-install-banner');
            });
            btnInstall.onclick = async () => {
              if (!deferredPrompt) return;
              deferredPrompt.prompt();
              const { outcome } = await deferredPrompt.userChoice;
              if (outcome !== 'dismissed') banner.classList.remove('show');
              deferredPrompt = null;
            };
          } else {
            title.textContent = '加入主畫面（iOS）';
            hint.innerHTML = '在 Safari 按 <b>分享</b> → <b>加入到主畫面</b>，即可離線全螢幕遊玩';
            btnInstall.textContent = '知道了';
            banner.classList.add('show');
            document.documentElement.classList.add('has-install-banner');
            btnInstall.onclick = () => {
              banner.classList.remove('show');
              document.documentElement.classList.remove('has-install-banner');
            };
          }
          btnDismiss.onclick = () => {
            localStorage.setItem(DISMISS_KEY, '1');
            banner.classList.remove('show');
            document.documentElement.classList.remove('has-install-banner');
          };
        }
      }

      // ===== 輸入管理（批次丟到 Worker）=====
      class AdvancedInputManager {
        constructor(gameEngine) {
          this.gameEngine = gameEngine;
          const area = document.getElementById('gameArea');
          area.addEventListener('pointerdown', this.onDown.bind(this), {
            passive: false,
          });
          area.addEventListener('pointermove', this.onMove.bind(this), {
            passive: false,
          });
          area.addEventListener('pointerup', this.onUp.bind(this), {
            passive: false,
          });
          area.addEventListener('pointercancel', this.onUp.bind(this), {
            passive: false,
          });
          area.addEventListener('contextmenu', e => e.preventDefault());
          area.addEventListener('dblclick', e => e.preventDefault());

          const pump = () => {
            if (fxWorker && GameState.tapQueues.length) {
              fxWorker.postMessage({
                type: 'batch',
                taps: GameState.tapQueues.splice(0, GameState.tapQueues.length),
              });
            }
            requestAnimationFrame(pump);
          };
          requestAnimationFrame(pump);
        }
        onDown(e) {
          if (!GameState.isPlaying) return;
          if (performance.now() < GameState.inputLockUntil) return;
          e.preventDefault();
          const rect = e.currentTarget.getBoundingClientRect();
          const x = e.clientX - rect.left,
            y = e.clientY - rect.top;
          const id = e.pointerId;
          e.currentTarget.setPointerCapture(id);

          let playerId;
          if (GameState.mode === 'single') {
            playerId = 'single';
          } else {
            playerId = y < rect.height / 2 ? 'player1' : 'player2';
          }

          GameState.pointers.set(id, { playerId, element: e.currentTarget });

          const now = performance.now();

          // 記錄點擊時間戳用於 TPS 計算
          GameState.tapTimestamps[playerId].push(now);

          // 計算當前真實 TPS
          const currentTPS = calculateRealTPS(playerId);
          GameState.tpsEMA[playerId] = currentTPS;

          const tier = tpsToLevel(currentTPS);
          GameState.lastTapTime[playerId] = now;

          // 單人模式第一次點擊時開始計時
          if (GameState.mode === 'single' && !GameState.hasStarted) {
            GameState.hasStarted = true;
            this.gameEngine.startTime = now; // 重設開始時間
            console.log('🎮 遊戲計時開始！');
          }

          GameState.activePointers.set(id, { x, y, playerId, tier });
          GameState.scores[playerId]++;
          uiManager.updateScoreDisplay();
          uiManager.animateScore(playerId);

          // 單人模式更新鼓勵文字
          if (GameState.mode === 'single') {
            uiManager.updateEncouragementText(currentTPS);
          }

          // 水波紋觸發條件：每秒點擊 > 20 且每 3 次觸發一次
          const rippleOk = currentTPS > 20 && GameState.scores[playerId] % 3 === 0;
          // 超高速閃電效果：TPS > 30 (與顯示邏輯保持一致)
          const ultraSpeed = currentTPS > 30;

          GameState.tapQueues.push({
            x,
            y,
            ts: now,
            tier,
            playerId,
            mode: GameState.mode,
            rippleEligible: rippleOk,
            ultraSpeed: ultraSpeed,
          });

          audioManager.play('tap', 0.5);
          audioManager.vibrate();
          if (GameState.mode === 'dual') {
            const zone = document.querySelector(`.player-zone.${playerId}`);
            if (zone) zone.classList.add('active');
          }
        }
        onMove(e) {
          if (!GameState.isPlaying) return;
          e.preventDefault();
          const rect = e.currentTarget.getBoundingClientRect();
          const x = e.clientX - rect.left,
            y = e.clientY - rect.top;
          const p = GameState.activePointers.get(e.pointerId);
          if (p) {
            p.x = x;
            p.y = y;
          }
        }
        onUp(e) {
          const meta = GameState.pointers.get(e.pointerId);
          if (meta) {
            try {
              meta.element.releasePointerCapture(e.pointerId);
            } catch (_) {}
            if (GameState.mode === 'dual') {
              const zone = document.querySelector(`.player-zone.${meta.playerId}`);
              if (zone) zone.classList.remove('active');
            }
          }
          GameState.pointers.delete(e.pointerId);
          GameState.activePointers.delete(e.pointerId);
        }
      }

      // ===== 遊戲引擎 =====
      class AdvancedGameEngine {
        constructor() {
          this.animationFrame = null;
          this.startTime = 0;
          this.lastCountdownSecond = null;
          this.isFullscreen = false;
        }
        async startSinglePlayer() {
          await this.enterFullscreen();
          this.startGame('single', 0);
        }
        async startDualPlayer() {
          await this.enterFullscreen();
          this.startGame('dual', 1000);
        } // 開頭延遲 1 秒

        async enterFullscreen() {
          // 只在移動設備時自動全螢幕
          if (!this.isMobileDevice()) {
            return;
          }

          try {
            const el = document.documentElement;
            if (el.requestFullscreen) await el.requestFullscreen();
            else if (el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
            this.isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement);
          } catch (_) {}
        }

        isMobileDevice() {
          // 檢測是否為移動設備（手機或平板）
          const userAgent = navigator.userAgent.toLowerCase();
          const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(
            userAgent
          );
          const isTablet = /ipad|android(?!.*mobile)/i.test(userAgent);
          const hasTouchScreen = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
          const isSmallScreen = window.innerWidth <= 1024; // 平板尺寸以下

          return isMobile || isTablet || (hasTouchScreen && isSmallScreen);
        }
        async exitFullscreen() {
          const doc = document;
          const fsEl = doc.fullscreenElement || doc.webkitFullscreenElement;
          if (!fsEl) {
            this.isFullscreen = false;
            return;
          }
          if (doc.visibilityState !== 'visible') {
            this.isFullscreen = false;
            return;
          }
          try {
            if (doc.exitFullscreen) {
              await doc.exitFullscreen().catch(() => {});
            } else if (doc.webkitExitFullscreen) {
              doc.webkitExitFullscreen();
            }
          } catch (_) {}
          this.isFullscreen = false;
        }

        startGame(mode, delayMs) {
          if (GameState.isPlaying) return;
          GameState.mode = mode;
          GameState.isPlaying = true;
          GameState.hasStarted = false; // 重置開始狀態
          GameState.timeLeft = GameState.settings.gameDuration;
          GameState.scores = { single: 0, player1: 0, player2: 0 };
          GameState.pointers.clear();
          GameState.activePointers.clear();
          GameState.lastTapTime = { single: 0, player1: 0, player2: 0 };
          GameState.tpsEMA = { single: 0, player1: 0, player2: 0 };
          GameState.tapTimestamps = { single: [], player1: [], player2: [] };
          GameState.maxTPS = { single: 0, player1: 0, player2: 0 };
          GameState.tapQueues.length = 0;

          // 啟動 TPS 更新定時器
          if (GameState.tpsUpdateInterval) {
            clearInterval(GameState.tpsUpdateInterval);
          }
          GameState.tpsUpdateInterval = setInterval(updateAllTPS, 100); // 每100ms更新一次
          GameState.inputLockUntil = performance.now() + (mode === 'dual' ? delayMs : 0);

          const appEl = document.getElementById('app');
          appEl.classList.toggle('single', mode === 'single');
          appEl.classList.toggle('dual', mode === 'dual');

          document.getElementById('gameHeader').classList.toggle('hidden', mode === 'dual');
          uiManager.showGameScreen(mode);
          uiManager.updateGameUI();
          uiManager.updateScoreDisplay();
          resizeFx();

          const syncActive = () => {
            if (!GameState.isPlaying) return;
            const arr = [];
            GameState.activePointers.forEach(v => arr.push(v));
            fxWorker && fxWorker.postMessage({ type: 'active', active: arr });
            setTimeout(syncActive, 66);
          };
          syncActive();

          this.startTime = performance.now() + delayMs;
          this.lastCountdownSecond = null;

          const loop = ts => {
            if (!GameState.isPlaying) return;

            // 在雙人模式中，於預定開始時間自動啟動計時（避免永不倒數）
            if (GameState.mode === 'dual' && !GameState.hasStarted && ts >= this.startTime) {
              GameState.hasStarted = true;
            }

            // 只有在遊戲已開始時才計時
            if (GameState.hasStarted) {
              const elapsed = (ts - this.startTime) / 1000;
              GameState.timeLeft = Math.max(
                0,
                GameState.settings.gameDuration - Math.max(0, elapsed)
              );
            }
            uiManager.updateTimer();

            if (GameState.timeLeft <= 3 && GameState.timeLeft > 0) {
              const secs = Math.ceil(GameState.timeLeft);
              if (secs !== this.lastCountdownSecond) {
                audioManager.play('countdown');
                this.lastCountdownSecond = secs;
              }
            }
            if (GameState.timeLeft <= 0) {
              this.endGame();
              return;
            }
            this.animationFrame = requestAnimationFrame(loop);
          };
          this.animationFrame = requestAnimationFrame(loop);
        }

        async endGame() {
          GameState.isPlaying = false;
          if (this.animationFrame) {
            cancelAnimationFrame(this.animationFrame);
            this.animationFrame = null;
          }
          // 清理 TPS 更新定時器
          if (GameState.tpsUpdateInterval) {
            clearInterval(GameState.tpsUpdateInterval);
            GameState.tpsUpdateInterval = null;
          }
          // 清理 Ultra Speed timeout
          if (GameState.ultraSpeedTimeout) {
            clearTimeout(GameState.ultraSpeedTimeout);
            GameState.ultraSpeedTimeout = null;
          }
          if (GameState.ultraSpeedTimeout1) {
            clearTimeout(GameState.ultraSpeedTimeout1);
            GameState.ultraSpeedTimeout1 = null;
          }
          if (GameState.ultraSpeedTimeout2) {
            clearTimeout(GameState.ultraSpeedTimeout2);
            GameState.ultraSpeedTimeout2 = null;
          }
          const result = this.calculateResult();
          await this.playFireworks(); // 播完煙火再顯示結果
          audioManager.play('victory', 0.9);
          uiManager.showResult(result);
        }

        calculateResult() {
          const r = { hasWinner: false, winner: null, score: 0, score2: 0 };
          if (GameState.mode === 'single') {
            r.score = GameState.scores.single;
            r.hasWinner = r.score > 0;
            storageManager.saveScore('single', r.score, null, GameState.maxTPS.single);
          } else {
            r.score = GameState.scores.player1;
            r.score2 = GameState.scores.player2;
            if (r.score > r.score2) {
              r.winner = 'player1';
              r.hasWinner = true;
            } else if (r.score2 > r.score) {
              r.winner = 'player2';
              r.hasWinner = true;
            }
            const maxTPS = Math.max(GameState.maxTPS.player1, GameState.maxTPS.player2);
            storageManager.saveScore(
              'dual',
              Math.max(r.score, r.score2),
              Math.min(r.score, r.score2),
              maxTPS
            );
          }
          return r;
        }

        playFireworks() {
          const container = document.getElementById('fireworkContainer');
          const colors = [
            '#f66fb9',
            '#ffb2dc',
            '#7ccaff',
            '#52b7ff',
            '#ffffff',
            '#ff6b6b',
            '#4ecdc4',
            '#45b7d1',
            '#96ceb4',
            '#ffeaa7',
            '#dda0dd',
            '#ff69b4',
            '#00ff00',
            '#ffd700',
            '#ff4500',
          ];
          const count = 24;
          const duration = 5500;

          return new Promise(resolve => {
            // Add victory screen flash effect
            document.getElementById('app').style.animation = 'victoryFlash 0.8s ease-out';

            for (let i = 0; i < count; i++) {
              setTimeout(
                () => {
                  const cx = Math.random() * window.innerWidth;
                  const cy = Math.random() * (window.innerHeight * 0.7) + window.innerHeight * 0.15;
                  const fireworkType = Math.random();

                  if (fireworkType < 0.3) {
                    // Large burst firework
                    this.createBurstFirework(container, cx, cy, colors, 18, 180);
                  } else if (fireworkType < 0.6) {
                    // Ring firework
                    this.createRingFirework(container, cx, cy, colors, 16, 150);
                  } else if (fireworkType < 0.85) {
                    // Spiral firework
                    this.createSpiralFirework(container, cx, cy, colors, 24, 200);
                  } else {
                    // Chain explosion
                    this.createChainFirework(container, cx, cy, colors, 12, 120);
                  }

                  // Enhanced audio with random pitch
                  audioManager.play('firework', 0.3 + Math.random() * 0.4);

                  // Random victory sound bursts
                  if (Math.random() < 0.3) {
                    setTimeout(() => audioManager.play('victory', 0.1), Math.random() * 300);
                  }
                },
                i * (duration / count) + Math.random() * 200
              );
            }

            // Grand finale
            setTimeout(() => {
              this.createGrandFinale(container, colors);
              audioManager.play('victory', 0.8);
            }, duration * 0.8);

            setTimeout(() => {
              container.innerHTML = '';
              document.getElementById('app').style.animation = '';
              resolve();
            }, duration + 800);
          });
        }

        createBurstFirework(container, cx, cy, colors, particles, maxDist) {
          for (let j = 0; j < particles; j++) {
            const dot = document.createElement('div');
            dot.className = 'firework';
            const c = colors[Math.floor(Math.random() * colors.length)];
            dot.style.background = `radial-gradient(circle, ${c}, transparent)`;
            dot.style.boxShadow = `0 0 20px ${c}, 0 0 40px ${c}`;
            dot.style.left = cx + 'px';
            dot.style.top = cy + 'px';
            dot.style.width = 4 + Math.random() * 6 + 'px';
            dot.style.height = dot.style.width;
            container.appendChild(dot);

            const ang = (j / particles) * Math.PI * 2 + Math.random() * 0.5;
            const dist = maxDist * (0.7 + Math.random() * 0.6);
            const dur = 1200 + Math.random() * 800;

            dot
              .animate(
                [
                  { transform: 'translate(0,0) scale(1)', opacity: 1 },
                  {
                    transform: `translate(${Math.cos(ang) * dist}px, ${
                      Math.sin(ang) * dist + Math.random() * 50
                    }px) scale(0)`,
                    opacity: 0,
                  },
                ],
                {
                  duration: dur,
                  easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)',
                }
              )
              .addEventListener('finish', () => dot.remove());
          }
        }

        createRingFirework(container, cx, cy, colors, particles, radius) {
          for (let j = 0; j < particles; j++) {
            const dot = document.createElement('div');
            dot.className = 'firework';
            const c = colors[Math.floor(Math.random() * colors.length)];
            dot.style.background = c;
            dot.style.boxShadow = `0 0 15px ${c}`;
            dot.style.left = cx + 'px';
            dot.style.top = cy + 'px';
            dot.style.width = '6px';
            dot.style.height = '6px';
            container.appendChild(dot);

            const ang = (j / particles) * Math.PI * 2;
            const dur = 1000 + Math.random() * 400;

            dot
              .animate(
                [
                  { transform: 'translate(0,0) scale(1)', opacity: 1 },
                  {
                    transform: `translate(${Math.cos(ang) * radius}px, ${
                      Math.sin(ang) * radius
                    }px) scale(0.3)`,
                    opacity: 0.8,
                    offset: 0.7,
                  },
                  {
                    transform: `translate(${Math.cos(ang) * radius * 1.2}px, ${
                      Math.sin(ang) * radius * 1.2
                    }px) scale(0)`,
                    opacity: 0,
                  },
                ],
                { duration: dur, easing: 'ease-out' }
              )
              .addEventListener('finish', () => dot.remove());
          }
        }

        createSpiralFirework(container, cx, cy, colors, particles, maxDist) {
          for (let j = 0; j < particles; j++) {
            const dot = document.createElement('div');
            dot.className = 'firework';
            const c = colors[Math.floor(Math.random() * colors.length)];
            dot.style.background = `linear-gradient(45deg, ${c}, transparent)`;
            dot.style.boxShadow = `0 0 12px ${c}`;
            dot.style.left = cx + 'px';
            dot.style.top = cy + 'px';
            dot.style.width = '3px';
            dot.style.height = '15px';
            dot.style.borderRadius = '50%';
            container.appendChild(dot);

            const spiral = j * 0.8;
            const dist = (j / particles) * maxDist;
            const dur = 1500 + Math.random() * 600;

            dot
              .animate(
                [
                  {
                    transform: 'translate(0,0) rotate(0deg) scale(1)',
                    opacity: 1,
                  },
                  {
                    transform: `translate(${Math.cos(spiral) * dist}px, ${
                      Math.sin(spiral) * dist
                    }px) rotate(${(spiral * 180) / Math.PI}deg) scale(0)`,
                    opacity: 0,
                  },
                ],
                { duration: dur, easing: 'ease-out' }
              )
              .addEventListener('finish', () => dot.remove());
          }
        }

        createChainFirework(container, cx, cy, colors, particles, dist) {
          for (let j = 0; j < particles; j++) {
            setTimeout(() => {
              const dot = document.createElement('div');
              dot.className = 'firework';
              const c = colors[Math.floor(Math.random() * colors.length)];
              dot.style.background = c;
              dot.style.boxShadow = `0 0 25px ${c}, 0 0 50px ${c}`;
              dot.style.left = cx + (Math.random() - 0.5) * 100 + 'px';
              dot.style.top = cy + (Math.random() - 0.5) * 100 + 'px';
              dot.style.width = '8px';
              dot.style.height = '8px';
              container.appendChild(dot);

              const ang = Math.random() * Math.PI * 2;
              const d = dist * (0.8 + Math.random() * 0.4);

              dot
                .animate(
                  [
                    { transform: 'translate(0,0) scale(1)', opacity: 1 },
                    {
                      transform: `translate(${Math.cos(ang) * d}px, ${
                        Math.sin(ang) * d
                      }px) scale(0)`,
                      opacity: 0,
                    },
                  ],
                  { duration: 800, easing: 'ease-out' }
                )
                .addEventListener('finish', () => dot.remove());
            }, j * 50);
          }
        }

        createGrandFinale(container, colors) {
          // Create multiple large bursts simultaneously
          for (let i = 0; i < 6; i++) {
            const cx = (window.innerWidth / 6) * (i + 0.5);
            const cy = window.innerHeight * (0.3 + Math.random() * 0.4);
            this.createBurstFirework(container, cx, cy, colors, 32, 250);

            setTimeout(() => {
              this.createRingFirework(container, cx, cy, colors, 24, 200);
            }, 300);
          }

          // Add confetti shower
          setTimeout(() => {
            for (let i = 0; i < 100; i++) {
              const confetti = document.createElement('div');
              confetti.style.position = 'absolute';
              confetti.style.width = '6px';
              confetti.style.height = '6px';
              confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
              confetti.style.left = Math.random() * window.innerWidth + 'px';
              confetti.style.top = '-10px';
              confetti.style.borderRadius = '2px';
              container.appendChild(confetti);

              confetti
                .animate(
                  [
                    { transform: 'translateY(0) rotate(0deg)', opacity: 1 },
                    {
                      transform: `translateY(${
                        window.innerHeight + 50
                      }px) rotate(${Math.random() * 720}deg)`,
                      opacity: 0,
                    },
                  ],
                  {
                    duration: 3000 + Math.random() * 2000,
                    easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)',
                  }
                )
                .addEventListener('finish', () => confetti.remove());
            }
          }, 600);
        }

        async exitGame() {
          GameState.isPlaying = false;
          if (this.animationFrame) {
            cancelAnimationFrame(this.animationFrame);
            this.animationFrame = null;
          }
          // 清理 TPS 更新定時器
          if (GameState.tpsUpdateInterval) {
            clearInterval(GameState.tpsUpdateInterval);
            GameState.tpsUpdateInterval = null;
          }
          // 清理 Ultra Speed timeout
          if (GameState.ultraSpeedTimeout) {
            clearTimeout(GameState.ultraSpeedTimeout);
            GameState.ultraSpeedTimeout = null;
          }
          if (GameState.ultraSpeedTimeout1) {
            clearTimeout(GameState.ultraSpeedTimeout1);
            GameState.ultraSpeedTimeout1 = null;
          }
          if (GameState.ultraSpeedTimeout2) {
            clearTimeout(GameState.ultraSpeedTimeout2);
            GameState.ultraSpeedTimeout2 = null;
          }
          await this.exitFullscreen();
          uiManager.showMenuScreen();
        }
      }

      // ===== 初始化 =====
      let audioManager, inputManager, gameEngine, storageManager, uiManager;

      // 暴露到全局作用域以便調試
      window.GameState = GameState;
      let isInitialized = false;

      document.addEventListener('DOMContentLoaded', () => {
        // 防止重複初始化
        if (isInitialized) {
          console.log('Game already initialized, skipping...');
          return;
        }

        console.log('Initializing Bunny Click...');

        try {
          // 檢查版本更新
          checkForUpdates();

          audioManager = new AdvancedAudioManager();
          storageManager = new StorageManager();
          gameEngine = new AdvancedGameEngine();
          uiManager = new AdvancedUIManager();
          inputManager = new AdvancedInputManager(gameEngine);
          // Worker 延遲初始化 - 遊戲開始時才載入

          // 更新版本號顯示
          updateVersionDisplay();

          // 暴露到全局作用域以便調試
          window.gameEngine = gameEngine;
          window.uiManager = uiManager;
          window.inputManager = inputManager;

          isInitialized = true;
          console.log('✅ Game initialization complete');
        } catch (error) {
          console.error('❌ Game initialization failed: [ERROR FILTERED]');
        }

        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('./sw.js').catch(() => {
            /* 靜默失敗 */
          });
        }

        if (
          'connection' in navigator &&
          navigator.connection &&
          navigator.connection.saveData === true
        ) {
          document.documentElement.classList.add('save-data');
        }

        // 字體載入檢測優化，避免首屏看到英文
        Promise.all([
          document.fonts.load('1em "Material Symbols Rounded"'),
          document.fonts.load('1em "Fredoka One"'),
        ])
          .then(() => {
            document.documentElement.classList.add('fonts-ready');
          })
          .catch(() => {
            // 如果載入失敗，1.5秒後顯示避免永久隱藏
            setTimeout(() => document.documentElement.classList.add('fonts-ready'), 1500);
          });
      });

      // 全螢幕事件：不要在這裡呼叫 exitGame() 以免遞迴
      document.addEventListener('fullscreenchange', () => {
        const isFs = !!(document.fullscreenElement || document.webkitFullscreenElement);
        gameEngine.isFullscreen = isFs;
        if (!isFs && GameState.isPlaying) {
          GameState.isPlaying = false;
          uiManager.showMenuScreen();
        }
      });

      // 禁用雙擊放大
      (function preventZoom() {
        let last = 0;
        document.addEventListener(
          'touchend',
          e => {
            const now = Date.now();
            if (now - last <= 300) {
              e.preventDefault();
            }
            last = now;
          },
          { passive: false }
        );
        ['gesturestart', 'gesturechange', 'gestureend'].forEach(evt =>
          document.addEventListener(evt, e => e.preventDefault())
        );
      })();
    </script>
  </body>
</html>

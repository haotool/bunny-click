# å“è³ªæª¢æŸ¥å·¥ä½œæµç¨‹
# åŸºæ–¼ .cursor/rules/quality.mdc è¦ç¯„çš„ CI/CD è‡ªå‹•åŒ–
# å»ºç«‹æ™‚é–“: 2025-08-26T23:10:06+08:00 [time.now:Asia/Taipei]
# è² è²¬äºº: haotool

name: ðŸ” å“è³ªæª¢æŸ¥

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '18'
  CACHE_PREFIX: v1

jobs:
  # ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
  code-quality:
    name: ðŸ“ ç¨‹å¼ç¢¼å“è³ª
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ“¦ è¨­ç½® Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ”§ å®‰è£ä¾è³´
        run: npm ci

      - name: ðŸ§¹ ESLint æª¢æŸ¥
        run: npm run lint:check

      - name: ðŸ’… Prettier æ ¼å¼æª¢æŸ¥
        run: npm run format:check

  # æ¸¬è©¦èˆ‡è¦†è“‹çŽ‡æª¢æŸ¥
  test-coverage:
    name: ðŸ§ª æ¸¬è©¦èˆ‡è¦†è“‹çŽ‡
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ“¦ è¨­ç½® Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ”§ å®‰è£ä¾è³´
        run: npm ci

      - name: ðŸ§ª åŸ·è¡Œæ¸¬è©¦
        run: npm run test:ci

      - name: ðŸ“Š ä¸Šå‚³è¦†è“‹çŽ‡å ±å‘Š
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # å®‰å…¨æ€§æª¢æŸ¥
  security-audit:
    name: ðŸ”’ å®‰å…¨æ€§æª¢æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ“¦ è¨­ç½® Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ”§ å®‰è£ä¾è³´
        run: npm ci

      - name: ðŸ” npm å®‰å…¨æŽƒæ
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: ðŸ›¡ï¸ ä¾è³´æ¼æ´žæª¢æŸ¥
        uses: actions/dependency-review-action@v3
        if: github.event_name == 'pull_request'

  # å»ºç½®æ¸¬è©¦
  build-test:
    name: ðŸ—ï¸ å»ºç½®æ¸¬è©¦
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ“¦ è¨­ç½® Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ”§ å®‰è£ä¾è³´
        run: npm ci

      - name: ðŸ—ï¸ å»ºç½®å°ˆæ¡ˆ
        run: npm run build

      - name: ðŸ“¦ ä¸Šå‚³å»ºç½®ç”¢ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 1

  # Lighthouse PWA æª¢æŸ¥
  lighthouse-pwa:
    name: ðŸ’¡ Lighthouse PWA
    runs-on: ubuntu-latest
    needs: build-test

    steps:
      - name: ðŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ“¦ è¨­ç½® Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ”§ å®‰è£ä¾è³´
        run: npm ci

      - name: ðŸ“¦ ä¸‹è¼‰å»ºç½®ç”¢ç‰©
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: ðŸ’¡ åŸ·è¡Œ Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.12.x
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  # å“è³ªé–€æª»ç¸½æª¢æŸ¥
  quality-gates:
    name: ðŸŽ¯ å“è³ªé–€æª»
    runs-on: ubuntu-latest
    needs: [code-quality, test-coverage, security-audit, build-test]

    steps:
      - name: ðŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ“¦ è¨­ç½® Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ”§ å®‰è£ä¾è³´
        run: npm ci

      - name: ðŸ“¦ ä¸‹è¼‰å»ºç½®ç”¢ç‰©
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: ðŸŽ¯ åŸ·è¡Œå“è³ªé–€æª»æª¢æŸ¥
        run: npm run quality:check

      - name: ðŸ“Š å“è³ªå ±å‘Šæ‘˜è¦
        run: |
          echo "## ðŸŽ¯ å“è³ªæª¢æŸ¥çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥é€šéŽ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æ¸¬è©¦è¦†è“‹çŽ‡é”æ¨™" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å®‰å…¨æ€§æª¢æŸ¥é€šéŽ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å»ºç½®æ¸¬è©¦æˆåŠŸ" >> $GITHUB_STEP_SUMMARY

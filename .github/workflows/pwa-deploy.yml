# PWA è‡ªå‹•éƒ¨ç½²å·¥ä½œæµç¨‹
# åŸºæ–¼ .cursor/rules/pwa.mdc è¦ç¯„çš„è‡ªå‹•åŒ–éƒ¨ç½²
# å»ºç«‹æ™‚é–“: 2025-08-26T23:10:06+08:00 [time.now:Asia/Taipei]
# è² è²¬äºº: haotool

name: ðŸš€ PWA éƒ¨ç½²

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  # å»ºç½®èˆ‡æ¸¬è©¦
  build-and-test:
    name: ðŸ—ï¸ å»ºç½®èˆ‡æ¸¬è©¦
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ“¦ è¨­ç½® Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ”§ å®‰è£ä¾è³´
        run: npm ci

      - name: ðŸ§ª åŸ·è¡Œæ¸¬è©¦
        run: npm run test:ci

      - name: ðŸ—ï¸ å»ºç½® PWA
        run: npm run build

      - name: ðŸ“¦ ä¸Šå‚³å»ºç½®ç”¢ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: pwa-dist
          path: dist/
          retention-days: 30

  # PWA åŠŸèƒ½é©—è­‰
  pwa-validation:
    name: ðŸ“± PWA åŠŸèƒ½é©—è­‰
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: ðŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ“¦ è¨­ç½® Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ”§ å®‰è£ä¾è³´
        run: npm ci

      - name: ðŸ“¦ ä¸‹è¼‰å»ºç½®ç”¢ç‰©
        uses: actions/download-artifact@v3
        with:
          name: pwa-dist
          path: dist/

      - name: ðŸ“± PWA åŠŸèƒ½é©—è­‰
        run: npm run pwa:validate

      - name: ðŸ’¡ Lighthouse PWA æª¢æŸ¥
        run: |
          npm install -g @lhci/cli@0.12.x
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  # éƒ¨ç½²åˆ° GitHub Pages
  deploy-github-pages:
    name: ðŸŒ éƒ¨ç½²åˆ° GitHub Pages
    runs-on: ubuntu-latest
    needs: [build-and-test, pwa-validation]
    if: github.ref == 'refs/heads/main'

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ðŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ“¦ ä¸‹è¼‰å»ºç½®ç”¢ç‰©
        uses: actions/download-artifact@v3
        with:
          name: pwa-dist
          path: dist/

      - name: ðŸ“„ è¨­ç½® GitHub Pages
        uses: actions/configure-pages@v3

      - name: ðŸ“¤ ä¸Šå‚³ Pages ç”¢ç‰©
        uses: actions/upload-pages-artifact@v2
        with:
          path: dist/

      - name: ðŸš€ éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

  # å»ºç«‹ Release
  create-release:
    name: ðŸ“¦ å»ºç«‹ Release
    runs-on: ubuntu-latest
    needs: [build-and-test, pwa-validation]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: ðŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ“¦ ä¸‹è¼‰å»ºç½®ç”¢ç‰©
        uses: actions/download-artifact@v3
        with:
          name: pwa-dist
          path: dist/

      - name: ðŸ“¦ æ‰“åŒ… Release
        run: |
          cd dist
          zip -r ../bunny-click-${{ github.ref_name }}.zip .
          cd ..

      - name: ðŸ“ ç”Ÿæˆ Release Notes
        id: release_notes
        run: |
          echo "## ðŸŽ® Bunny Click PWA v${{ github.ref_name }}" > release_notes.md
          echo "" >> release_notes.md
          echo "### âœ¨ æ–°åŠŸèƒ½" >> release_notes.md
          echo "- PWA è‡ªå‹•æ›´æ–°æ©Ÿåˆ¶" >> release_notes.md
          echo "- é–‹ç™¼éšŽæ®µ Service Worker æ¸¬è©¦" >> release_notes.md
          echo "- æ¨™æº–åŒ–ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥" >> release_notes.md
          echo "- å®Œæ•´çš„å°ˆæ¡ˆé€²åº¦è¿½è¹¤" >> release_notes.md
          echo "" >> release_notes.md
          echo "### ðŸ”§ æŠ€è¡“æ”¹å–„" >> release_notes.md
          echo "- å‡ç´š Vite PWA é…ç½®æœ€ä½³å¯¦è¸" >> release_notes.md
          echo "- å¯¦æ–½å“è³ªé–€æª»è‡ªå‹•åŒ–æª¢æŸ¥" >> release_notes.md
          echo "- å»ºç«‹ Lighthouse CI æµç¨‹" >> release_notes.md
          echo "- å¼·åŒ– pre-commit hooks" >> release_notes.md

      - name: ðŸ·ï¸ å»ºç«‹ GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Bunny Click PWA ${{ github.ref_name }}
          body_path: release_notes.md
          draft: false
          prerelease: false

      - name: ðŸ“Ž ä¸Šå‚³ Release æª”æ¡ˆ
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: bunny-click-${{ github.ref_name }}.zip
          asset_name: bunny-click-${{ github.ref_name }}.zip
          asset_content_type: application/zip

  # éƒ¨ç½²é€šçŸ¥
  deployment-notification:
    name: ðŸ“¢ éƒ¨ç½²é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [deploy-github-pages]
    if: always() && github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“Š éƒ¨ç½²ç‹€æ…‹æ‘˜è¦
        run: |
          echo "## ðŸš€ PWA éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± PWA åŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Service Worker è‡ªå‹•æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… é›¢ç·šåŠŸèƒ½æ”¯æ´" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å®‰è£æç¤ºåŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PWA Manifest å®Œæ•´" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— é€£çµ" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸŒ ç·šä¸ŠéŠæˆ²](https://your-username.github.io/bunny-click/)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“Š Lighthouse å ±å‘Š](https://github.com/${{ github.repository }}/actions)" >> $GITHUB_STEP_SUMMARY
